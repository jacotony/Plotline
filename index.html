<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>PlotLine</title>

<!-- iOS meta/icons -->
<meta name="theme-color" content="#2f4a3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="PlotLine">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link id="app-manifest" rel="manifest">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAADYCAQAAAAzSx0mAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE="/>

<style>
  :root{
    --paper:#f4f1ea; --paper-2:#fbfaf7; --ink:#382110; --ink-2:#333;
    --accent:#00635d; --gold:#f4c150; --line:#d6d0c4; --muted:#6a5d50;
    --shadow:0 4px 12px rgba(0,0,0,.08); --shadow-hover:0 8px 24px rgba(0,0,0,.12);
    --s-top: env(safe-area-inset-top, 0px);
    --s-right: env(safe-area-inset-right, 0px);
    --s-bottom: env(safe-area-inset-bottom, 0px);
    --s-left: env(safe-area-inset-left, 0px);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%}
  body{
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; -webkit-tap-highlight-color: transparent;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    background:var(--paper);color:var(--ink);
    min-height:100dvh;
    padding:20px;
    padding-top:calc(20px + var(--s-top));
    padding-bottom:calc(20px + var(--s-bottom));
    padding-left:calc(20px + var(--s-left));
    padding-right:calc(20px + var(--s-right));
  }
  .container{max-width:1200px;margin:0 auto}
  .header{color:var(--ink);text-align:center;margin-bottom:28px}
  .header h1{font-size:2.2rem;margin-bottom:8px;font-family:Georgia,'Times New Roman',serif;font-weight:700;letter-spacing:-0.5px}
  .header p{opacity:.8;font-size:1rem;font-weight:500}

  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin:20px 0 32px}
  .stat{background:#fff;padding:20px;border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);text-align:center;transition:transform 0.2s ease,box-shadow 0.2s ease}
  .stat:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}
  .stat strong{font-size:2rem;line-height:1;display:block;color:var(--accent);font-weight:800}
  .stat span{font-size:0.85rem;color:var(--muted);font-weight:600;margin-top:4px;display:block}

  .content{background:#fff;border-radius:20px;padding:24px;box-shadow:var(--shadow);border:1px solid var(--line)}

  .nav{display:flex;gap:4px;margin-bottom:24px;background:var(--paper-2);padding:4px;border-radius:12px;border:1px solid var(--line)}
  .nav-btn{background:transparent;color:var(--muted);border:none;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s ease;flex:1;text-align:center}
  .nav-btn:hover{color:var(--accent)}
  .nav-btn.active{background:#fff;color:var(--accent);box-shadow:0 2px 4px rgba(0,0,0,.08)}

  .search-container{background:var(--paper-2);border-radius:16px;padding:20px;margin-bottom:24px;border:1px solid var(--line)}
  .search-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:12px;margin-bottom:16px}
  .search-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .input,.select{width:100%;padding:14px 16px;border:2px solid var(--line);border-radius:12px;font-size:15px;background:#fff;transition:border-color 0.2s ease,box-shadow 0.2s ease;font-weight:500}
  .input:focus,.select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,99,93,.08)}
  .input::placeholder{color:var(--muted)}

  .chip{background:var(--paper);border:2px solid var(--line);color:var(--ink);padding:8px 14px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  .results-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:16px}
  .results-info{font-size:15px;font-weight:600;color:var(--ink-2)}
  .results-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  .feed{display:grid;gap:20px}
  .group-section{margin-bottom:32px}
  .group-title{font-size:1.4rem;font-weight:800;color:var(--ink);margin-bottom:16px;display:flex;align-items:center;gap:12px}
  .group-count{background:var(--accent);color:#fff;padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:700}
  .books-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;overflow:visible}

  .book-card{border:2px solid var(--line);border-radius:16px;padding:20px;background:#fff;box-shadow:var(--shadow);transition:all 0.3s ease;position:relative;overflow:visible;z-index:1}
  .book-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);border-color:var(--accent);z-index:10}

  .book-header{display:flex;gap:16px;margin-bottom:16px}
  .book-cover{width:80px;height:120px;object-fit:cover;border-radius:8px;border:2px solid var(--line);flex-shrink:0;transition:transform 0.2s ease}
  .book-cover:hover{transform:scale(1.02)}
  .cover-placeholder{width:80px;height:120px;background:linear-gradient(135deg,var(--paper) 0%,var(--line) 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);flex-shrink:0;border:2px solid var(--line)}

  .book-info{flex:1;min-width:0}
  .book-meta{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .genre-chip{background:var(--paper);color:var(--ink);border:1px solid var(--line);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800}
  .series-chip{background:var(--paper-2);border:1px solid var(--accent);color:var(--accent);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800}

  .book-title{font-size:1.1rem;font-weight:800;color:var(--ink);line-height:1.3;font-family:Georgia,'Times New Roman',serif;margin-bottom:4px}
  .book-author{color:var(--muted);font-style:italic;margin-bottom:12px;font-size:14px;font-weight:500}

  .rating-section{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .stars{position:relative;display:inline-block;font-size:16px;line-height:1}
  .stars .bg{color:#ddd}
  .stars .fg{position:absolute;left:0;top:0;white-space:nowrap;color:var(--gold);pointer-events:none;overflow:hidden}
  .rating-text{font-size:13px;color:var(--muted);font-weight:600}

  .book-status{background:var(--paper-2);padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:12px;border-left:4px solid var(--accent)}
  .book-status.reading{border-left-color:#4CAF50}
  .book-status.wish{border-left-color:#FF9800}
  .book-status.upcoming{border-left-color:#2196F3}
  .book-status.read{border-left-color:var(--gold)}

  .book-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
  .tag{background:var(--paper-2);border:1px solid var(--line);color:var(--ink);padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600}

  .book-synopsis{color:var(--ink-2);line-height:1.5;font-size:14px;margin-bottom:16px;max-height:60px;overflow:hidden;position:relative}
  .book-synopsis.expanded{max-height:none}
  .synopsis-fade{position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(transparent,#fff);pointer-events:none}
  .synopsis-toggle{color:var(--accent);font-weight:600;font-size:13px;cursor:pointer;border:none;background:none;padding:0}

  .book-actions{display:flex;gap:8px;align-items:center}
  .action-btn{background:var(--paper);color:var(--accent);border:2px solid var(--line);padding:8px 16px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:700;transition:all 0.2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  .action-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);transform:translateY(-1px)}
  .action-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .action-btn.primary:hover{background:#004f49;border-color:#004f49}

  .more-menu{position:relative}
  .more-btn{width:36px;height:36px;border-radius:50%;background:var(--paper);border:2px solid var(--line);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease}
  .more-btn:hover{background:var(--line);border-color:var(--accent)}
  .dropdown{position:absolute;top:100%;right:0;background:#fff;border:2px solid var(--line);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);padding:8px 0;min-width:160px;z-index:9999;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s ease;max-height:300px;overflow:visible}
  .dropdown.show{opacity:1;visibility:visible;transform:translateY(0)}
  .dropdown.left{right:auto;left:-120px}
  .dropdown-item{display:block;padding:12px 16px;color:var(--ink);text-decoration:none;font-size:14px;font-weight:500;border:none;background:none;width:100%;text-align:left;cursor:pointer;transition:background 0.2s ease;white-space:nowrap}
  .dropdown-item:hover{background:var(--paper-2)}

  /* Force dropdown above everything on iOS */
  @supports (-webkit-touch-callout: none) {
    .dropdown{z-index:99999;position:fixed}
    .dropdown.show{position:absolute}
  }

  .toast{position:fixed;bottom:24px;right:24px;background:#2a2a2a;color:#fff;padding:16px 20px;border-radius:12px;opacity:0;transform:translateY(20px);transition:all 0.3s ease;pointer-events:none;z-index:9999;max-width:400px;box-shadow:var(--shadow-hover);font-weight:500}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#d32f2f}
  .toast.success{background:#2e7d32}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;opacity:0;visibility:hidden;transition:all 0.3s ease}
  .modal.show{opacity:1;visibility:visible}
  .modal-content{background:#fff;border-radius:20px;padding:28px;box-shadow:var(--shadow-hover);max-width:860px;width:92%;max-height:82vh;overflow:auto;transform:scale(0.9);transition:transform 0.3s ease}
  .modal.show .modal-content{transform:scale(1)}
  .modal-header{margin-bottom:20px}
  .modal-title{font-size:1.3rem;font-weight:800;color:var(--ink);margin-bottom:8px}
  .modal-subtitle{color:var(--muted);font-weight:500}

  .star-rating{display:flex;gap:4px;margin:16px 0}
  .star-btn{background:none;border:none;font-size:24px;color:#ddd;cursor:pointer;transition:color 0.2s ease}
  .star-btn:hover,.star-btn.active{color:var(--gold)}

  .search-modal .modal-content{max-width:800px}
  .search-results{max-height:420px;overflow:auto;background:var(--paper-2);border-radius:12px;padding:12px;margin:16px 0}
  .result-item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;padding:12px;border-radius:8px;margin-bottom:8px;background:#fff;border:2px solid var(--line);transition:border-color 0.2s ease;align-items:center}
  .result-item:hover{border-color:var(--accent)}
  .result-item:last-child{margin-bottom:0}
  .result-cover{width:48px;height:72px;object-fit:cover;border-radius:4px;border:1px solid var(--line)}
  .result-info{flex:1}
  .result-title{font-weight:700;margin-bottom:4px}
  .result-meta{font-size:12px;color:var(--muted);margin-bottom:2px}
  .result-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .result-tags .tag{background:var(--paper-2);border:1px solid var(--line);padding:2px 6px;border-radius:10px;font-size:11px}

  .loading{display:inline-block;width:20px;height:20px;border:2px solid var(--line);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

  .section{display:none}
  .section.active{display:block}

  .prefs-section{background:var(--paper-2);padding:20px;border-radius:16px;margin-bottom:20px;border:2px solid var(--line)}
  .prefs-title{font-size:1.2rem;font-weight:800;margin-bottom:16px;color:var(--ink)}
  .prefs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px}
  .prefs-field{display:flex;flex-direction:column;gap:8px}
  .prefs-label{font-size:13px;font-weight:700;color:var(--ink)}

  /* EDIT BOOK MODAL */
  .edit-grid{display:grid;grid-template-columns:140px 1fr;gap:16px}
  .edit-cover{width:140px;height:210px;border:1px solid var(--line);border-radius:8px;object-fit:cover;background:#eee}
  .edit-two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .chip-input{display:flex;flex-wrap:wrap;gap:8px}
  .chip-input .chip{padding:6px 10px;border-radius:14px}
  .chip-input input{min-width:160px;border:2px dashed var(--line);border-radius:10px;padding:8px 10px}

  @media(max-width:768px){
    .search-row{grid-template-columns:1fr;gap:12px}
    .books-grid{grid-template-columns:1fr}
    .stats{grid-template-columns:repeat(2,1fr)}
    .book-header{flex-direction:column;align-items:center;text-align:center}
    .book-cover,.cover-placeholder{width:100px;height:150px}
    .results-bar{flex-direction:column;align-items:stretch;gap:12px}
    .book-actions{justify-content:center;flex-wrap:wrap}
    .modal-content{padding:20px}
    .edit-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>PlotLine</h1>
      <p>Your personal reading companion</p>
    </header>

    <div class="stats" id="stats">
      <div class="stat">
        <strong id="total-books">0</strong>
        <span>Total Books</span>
      </div>
      <div class="stat">
        <strong id="books-read">0</strong>
        <span>Completed</span>
      </div>
      <div class="stat">
        <strong id="read-month">0</strong>
        <span>This Month</span>
      </div>
      <div class="stat">
        <strong id="read-year">0</strong>
        <span>This Year</span>
      </div>
      <div class="stat">
        <strong id="avg-rating">0.0</strong>
        <span>Avg Rating</span>
      </div>
    </div>

    <main class="content">
      <nav class="nav" id="main-nav">
        <button class="nav-btn active" id="feed-btn" type="button">Library</button>
        <button class="nav-btn" id="prefs-btn" type="button">Settings</button>
      </nav>

      <section id="feed" class="section active">
        <div class="search-container">
          <div class="search-row">
            <input type="text" class="input" placeholder="Search your library or add new books..." id="search-input"/>
            <select class="select" id="tag-filter"><option value="">All Tags</option></select>
            <select class="select" id="category-filter"><option value="">All Genres</option></select>
            <select class="select" id="min-rating">
              <option value="0">Any Rating</option>
              <option value="5">5 Stars</option>
              <option value="4">4+ Stars</option>
              <option value="3">3+ Stars</option>
            </select>
            <select class="select" id="sort-by">
              <option value="smart">Smart Sort</option>
              <option value="new">Recently Added</option>
              <option value="rating">Highest Rated</option>
              <option value="title">Title A-Z</option>
            </select>
          </div>
          <div class="search-controls">
            <label class="chip" style="cursor:pointer;">
              <input type="checkbox" id="collapse-synopsis" style="margin-right:8px;"> 
              Hide Synopses
            </label>
            <button class="action-btn" id="check-releases-btn" type="button">
              Check New Releases
            </button>
            <button class="action-btn primary" id="add-book-btn" type="button">+ Add Book</button>
          </div>
        </div>

        <div class="results-bar">
          <div class="results-info" id="result-count">Loading...</div>
          <div class="results-controls"></div>
        </div>

        <div id="books-feed" class="feed"></div>
      </section>

      <section id="prefs" class="section">
        <div class="prefs-section">
          <h3 class="prefs-title">Watched Series</h3>
          <p style="margin-bottom:16px;color:var(--muted);font-size:14px;">Series you're watching for new releases</p>
          <div id="watched-series-list" style="margin-bottom:16px;"></div>
        </div>

        <div class="prefs-section">
          <h3 class="prefs-title">Reading Goals</h3>
          <div class="prefs-grid">
            <div class="prefs-field">
              <label class="prefs-label">Year</label>
              <input id="goal-year" class="input" type="number"/>
            </div>
            <div class="prefs-field">
              <label class="prefs-label">Total Books</label>
              <input id="goal-total" class="input" type="number"/>
            </div>
            <div class="prefs-field">
              <label class="prefs-label">Catholic Books</label>
              <input id="goal-catholic" class="input" type="number"/>
            </div>
            <div class="prefs-field">
              <label class="prefs-label">Fiction</label>
              <input id="goal-fiction" class="input" type="number"/>
            </div>
            <div class="prefs-field">
              <label class="prefs-label">Non-Fiction</label>
              <input id="goal-nonfiction" class="input" type="number"/>
            </div>
          </div>
          <button id="save-goals" class="action-btn primary" type="button">Save Goals</button>
        </div>

        <div class="prefs-section">
          <h3 class="prefs-title">Export & Backup</h3>
          <p style="margin-bottom:16px;color:var(--muted);font-size:14px;">Download your data or import from backup</p>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
            <button id="export-csv-btn" class="action-btn" type="button">Download CSV</button>
            <button id="export-json-btn" class="action-btn" type="button">Download JSON</button>
            <label class="action-btn" style="cursor:pointer">
              Import Data
              <input type="file" id="import-json" accept="application/json" style="display:none">
            </label>
          </div>
        </div>

        <div class="prefs-section">
          <h3 class="prefs-title">Cloud Sync</h3>
          <div style="background:var(--paper);padding:16px;border-radius:12px;margin-bottom:16px;border:2px solid var(--line);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
              <span style="font-weight:600;">Status:</span>
              <span class="chip" id="sync-status">Ready</span>
            </div>
          </div>
          <div class="prefs-grid" style="margin-bottom:16px;">
            <div class="prefs-field">
              <label class="prefs-label">API Key</label>
              <input id="cloud-api" class="input" placeholder="Enter JSONBin API key" type="password"/>
            </div>
            <div class="prefs-field">
              <label class="prefs-label">Bin ID</label>
              <input id="cloud-bin" class="input" placeholder="Enter Bin ID"/>
            </div>
          </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <button id="cloud-save" class="action-btn" type="button">Save Config</button>
            <button id="cloud-create" class="action-btn" type="button">Create New Bin</button>
            <button id="cloud-pull" class="action-btn" type="button">Pull from Cloud</button>
            <button id="cloud-push" class="action-btn primary" type="button">Push to Cloud</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Rating Modal -->
  <div id="finish-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Rate this book</h3>
        <p class="modal-subtitle" id="finish-title"></p>
      </div>
      <div class="star-rating" id="star-rating"></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
        <button class="action-btn" id="finish-cancel" type="button">Cancel</button>
        <button class="action-btn primary" id="finish-save" type="button">Save Rating</button>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="modal search-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add New Books</h3>
        <p class="modal-subtitle">Search (any genre). Click a result to edit before adding.</p>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr auto;gap:12px;margin-bottom:16px;">
        <input id="ext-search-input" class="input" placeholder="Book title or series"/>
        <input id="ext-search-author" class="input" placeholder="Author (optional)"/>
        <button id="ext-search-btn" class="action-btn primary" type="button">Search</button>
      </div>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
        <button id="ext-select-all" class="action-btn" type="button">Select All</button>
        <button id="ext-add-selected" class="action-btn primary" type="button">Add Selected (Edit Each)</button>
        <label class="chip" style="cursor:pointer;">
          <input type="checkbox" id="ext-watch" style="margin-right:6px;"> Watch Series
        </label>
      </div>
      <div id="search-results" class="search-results"></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
        <button class="action-btn" id="ext-close" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit & Add Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Book Before Adding</h3>
        <p class="modal-subtitle">Adjust details, tags, and where it goes.</p>
      </div>
      <div class="edit-grid">
        <div>
          <img id="edit-cover" class="edit-cover" alt="">
          <input id="edit-cover-url" class="input" placeholder="Cover image URL" style="margin-top:8px;">
          <a id="edit-goodreads-link" class="action-btn" target="_blank" rel="noopener" style="margin-top:8px;display:inline-flex">Open on Goodreads</a>
        </div>
        <div>
          <div class="edit-two">
            <input id="edit-title" class="input" placeholder="Title">
            <input id="edit-author" class="input" placeholder="Author(s)">
          </div>
          <div class="edit-two" style="margin-top:12px;">
            <input id="edit-genre" class="input" placeholder="Genre (e.g., fantasy, biography)">
            <input id="edit-series" class="input" placeholder="Series (optional)">
          </div>
          <div class="edit-two" style="margin-top:12px;">
            <select id="edit-status" class="select">
              <option value="wish">Want to Read</option>
              <option value="reading">Currently Reading</option>
              <option value="read">Completed</option>
              <option value="upcoming">Upcoming</option>
            </select>
            <input id="edit-release" class="input" placeholder="Release date (YYYY-MM-DD)">
          </div>
          <div style="margin-top:12px;">
            <div class="chip-input" id="edit-tags-wrap"></div>
            <input id="edit-tags-input" class="input" placeholder="Add tag… (press Enter)" style="margin-top:8px;">
          </div>
          <textarea id="edit-synopsis" class="input" placeholder="Synopsis" style="margin-top:12px;height:110px"></textarea>
          <div id="edit-rating-wrap" style="margin-top:12px;display:none">
            <div style="font-weight:700;margin-bottom:6px;">Rating</div>
            <div id="edit-star-row" class="star-rating"></div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
        <button class="action-btn" id="edit-cancel" type="button">Cancel</button>
        <button class="action-btn primary" id="edit-save" type="button">Add to Library</button>
      </div>
    </div>
  </div>

<script>
/* ===== Kill old service workers ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
}

/* ===== Helpers ===== */
function rAll(str, search, replacement){ return String(str).split(search).join(replacement); }
function escapeHtml(s){ s=String(s==null?'':s); s=rAll(s,'&','&amp;'); s=rAll(s,'<','&lt;'); s=rAll(s,'>','&gt;'); return s; }
function escapeAttr(s){ return rAll(escapeHtml(s),'"','&quot;'); }
function nowISO(){ return new Date().toISOString(); }
function formatDate(v){ var n=Number(v); var d=new Date(isFinite(n)?n:v); try{ return d.toLocaleDateString(); }catch(_e){ return d.toISOString().slice(0,10);} }
function showToast(msg,isError){ 
  var t=document.getElementById('toast'); 
  t.textContent=msg; 
  t.classList.remove('error','success');
  if(isError) t.classList.add('error');
  else t.classList.add('success');
  t.classList.add('show'); 
  clearTimeout(showToast._t); 
  showToast._t=setTimeout(function(){ t.classList.remove('show'); }, isError?4000:2500); 
}
function truncate(s,n){ s=String(s||''); n=n||300; return s.length>n? s.slice(0,n-1)+'…' : s; }
function toDateObj(publishedDate){
  if(!publishedDate) return null;
  var parts = String(publishedDate).split('-').map(Number);
  var y=parts[0], m=(parts[1]||1)-1, d=(parts[2]||1);
  var dt=new Date(Date.UTC(y,m,d));
  return isNaN(dt.getTime())? null : dt;
}
function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

/* ===== Storage / Cloud (JSONBin v3) ===== */
const DEFAULT_JSONBIN_API = 'https://api.jsonbin.io/v3';
const DEFAULT_BIN_ID = '68b3cb8dd0ea881f406ca19e'; 
const DEFAULT_API_KEY = '$2a$10$1k.Aw1WU5YTjSlKmSLGQ3eK6gaEhRB/j.FzTEtMp7Ardqd7vI4i4C'; 

function getApiKey(){ return (localStorage.getItem('plotline_api_key') || DEFAULT_API_KEY).trim(); }
function getBinId(){ return (localStorage.getItem('plotline_bin_id') || DEFAULT_BIN_ID).trim(); }
function getApiBase(){ return (localStorage.getItem('plotline_api_base') || DEFAULT_JSONBIN_API).trim(); }

let books = [];
let sitePrefs = { goals: { year: new Date().getFullYear(), total: 0, byTag: { catholic:0, fiction:0, nonfiction:0 } }, watchSeries: {} };

function jbHeaders(){ return { 'Content-Type':'application/json','X-Master-Key': getApiKey(),'X-Bin-Meta': 'false','Accept':'application/json' }; }
function ns(record){ return (record && record.plotline) ? record.plotline : record; }

async function loadAll(){
  try{
    var cached = JSON.parse(localStorage.getItem('plotline_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.sitePrefs) sitePrefs = Object.assign({watchSeries:{}}, cached.sitePrefs);
  }catch(_e){}
  try{
    const r = await fetch(`${getApiBase()}/b/${getBinId()}/latest`,{headers: jbHeaders()});
    if(r.ok){
      const data = await r.json();
      const record = (data && (data.record ?? data)) || {};
      const scoped = ns(record);
      if (Array.isArray(scoped)) { books = scoped; }
      else {
        books = Array.isArray(scoped?.books) ? scoped.books
              : (Array.isArray(record) ? record : (record.books || books));
        sitePrefs = Object.assign({watchSeries:{}}, scoped?.sitePrefs || record.sitePrefs || sitePrefs);
      }
      try{ localStorage.setItem('plotline_payload', JSON.stringify({books,sitePrefs})); }catch(_e){}
      var s=document.getElementById('sync-status'); if(s) s.textContent='Synced';
    }
  }catch(e){ console.warn('Cloud pull failed; using local', e); }
}

async function saveAll(){
  try{ localStorage.setItem('plotline_payload', JSON.stringify({books,sitePrefs})); }catch(_e){}
  try{
    const latest = await fetch(`${getApiBase()}/b/${getBinId()}/latest`, { headers: jbHeaders() });
    let record = latest.ok ? ((await latest.json()).record || {}) : {};
    record.plotline = { books, sitePrefs };
    const r = await fetch(`${getApiBase()}/b/${getBinId()}`,{ method:'PUT', headers: jbHeaders(), body: JSON.stringify(record) });
    if(!r.ok){ const txt = await r.text(); throw new Error(`Push ${r.status}: ${txt.slice(0,140)}`); }
    var s=document.getElementById('sync-status'); if(s) s.textContent='Synced';
  }catch(e){ console.warn('Remote save failed',e); var s2=document.getElementById('sync-status'); if(s2) s2.textContent='Sync failed'; }
}

/* ===== Data Model Helpers ===== */
function newBook(obj){
  const id=Date.now()+Math.floor(Math.random()*1000);
  const b={
    id,
    title: (obj.title||'').trim(),
    author:(obj.author||'').trim(),
    image: (obj.image||'').trim(),
    synopsis: (obj.synopsis||'').trim(),
    genre: (obj.genre||'other').toLowerCase(),
    tags: Array.isArray(obj.tags)? obj.tags.slice(0,12).map(t=>String(t).toLowerCase().trim()).filter(Boolean) : [],
    addedAt: nowISO(),
    status: obj.status||'wish',
    releaseDate: obj.releaseDate||'',
    series: obj.series||null,
    sessions: [],
    rating: Number(obj.rating||0)||0
  };
  if(b.status==='wish') b.wantAt=nowISO();
  if(b.status==='upcoming') { b.wantAt=b.wantAt||nowISO(); }
  if(b.status==='reading') { b.wantAt=b.wantAt||nowISO(); startReading(b); }
  if(b.status==='read') { b.wantAt=b.wantAt||nowISO(); startReading(b); finishReading(b, obj.rating||0); }
  return b;
}

function startReading(b){
  if(!b.sessions) b.sessions=[];
  const open=b.sessions.find(s=>!s.finishedAt);
  if(open) return;
  b.sessions.push({startedAt: nowISO()});
  b.status='reading'; b.startAt = b.sessions[b.sessions.length-1].startedAt;
}

function finishReading(b, rating){
  if(!b.sessions || !b.sessions.length) startReading(b);
  const cur=b.sessions[b.sessions.length-1];
  if(!cur.finishedAt) cur.finishedAt=nowISO();
  if(isFinite(rating) && rating>0){ cur.rating = rating; b.rating = rating; }
  b.status='read'; b.finishAt = cur.finishedAt;
}

function setWish(b){ b.status='wish'; b.wantAt = b.wantAt || nowISO(); }

/* ===== Rendering ===== */
function starWidthFromRating(r){ r = Math.max(0, Math.min(5, Number(r)||0)); return (r/5*100).toFixed(0)+'%'; }

function formatStatus(book){
  const statusMap = {
    reading: { text: 'Currently Reading', class: 'reading' },
    wish: { text: 'Want to Read', class: 'wish' },
    upcoming: { text: 'Upcoming Release', class: 'upcoming' },
    read: { text: 'Completed', class: 'read' }
  };
  const status = statusMap[book.status] || statusMap.wish;
  let extra = '';
  if(book.status === 'read' && book.finishAt) extra = ` • ${formatDate(book.finishAt)}`;
  if(book.status === 'reading' && book.startAt) extra = ` • Started ${formatDate(book.startAt)}`;
  if(book.status === 'upcoming' && book.releaseDate) extra = ` • ${formatDate(book.releaseDate)}`;
  return `<div class="book-status ${status.class}">${status.text}${extra}</div>`;
}

function renderBookCard(book){
  const starWidth = starWidthFromRating(book.rating || 0);
  const collapsed = document.getElementById('collapse-synopsis')?.checked;
  const goodreadsUrl = `https://www.goodreads.com/search?q=${encodeURIComponent(book.title + ' ' + book.author)}`;
  const coverHtml = book.image 
    ? `<a href="${goodreadsUrl}" target="_blank" rel="noopener noreferrer"><img class="book-cover" src="${escapeAttr(book.image)}" alt="Cover of ${escapeAttr(book.title)}" loading="lazy"></a>`
    : `<a href="${goodreadsUrl}" target="_blank" rel="noopener noreferrer"><div class="cover-placeholder">No Cover</div></a>`;
  const seriesHtml = book.series?.name ? `<span class="series-chip">${escapeHtml(book.series.name)}${book.series.number ? ` #${book.series.number}` : ''}</span>` : '';
  const tagsHtml = book.tags?.length ? `<div class="book-tags">${book.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : '';
  const synopsisHtml = !collapsed && book.synopsis 
    ? `<div class="book-synopsis" data-book-id="${book.id}">
         <span class="synopsis-text">${escapeHtml(book.synopsis.length > 200 ? book.synopsis.slice(0, 200) + '...' : book.synopsis)}</span>
         ${book.synopsis.length > 200 ? `<button class="synopsis-toggle" data-action="toggle-synopsis" data-book-id="${book.id}">Read more</button>` : ''}
       </div>` : '';
  const ratingText = book.rating > 0 ? `${book.rating.toFixed(1)} stars` : 'Not rated';
  return `
    <div class="book-card" data-book-id="${book.id}">
      <div class="book-header">
        ${coverHtml}
        <div class="book-info">
          <div class="book-meta">
            <span class="genre-chip">${escapeHtml(book.genre || 'other')}</span>
            ${seriesHtml}
          </div>
          <h3 class="book-title">${escapeHtml(book.title)}</h3>
          <p class="book-author">by ${escapeHtml(book.author)}</p>
          <div class="rating-section">
            <div class="stars">
              <div class="bg">★★★★★</div>
              <div class="fg" style="width:${starWidth}">★★★★★</div>
            </div>
            <span class="rating-text">${ratingText}</span>
          </div>
          ${formatStatus(book)}
        </div>
      </div>
      ${tagsHtml}
      ${synopsisHtml}
      <div class="book-actions">
        ${getQuickActions(book)}
        <div class="more-menu">
          <button class="more-btn" data-action="toggle-menu" data-book-id="${book.id}">⋯</button>
          <div class="dropdown" data-book-id="${book.id}">
            <button class="dropdown-item" data-action="edit" data-book-id="${book.id}">Edit Details</button>
            <button class="dropdown-item" data-action="find-similar" data-book-id="${book.id}">Find Similar</button>
            <button class="dropdown-item" data-action="share" data-book-id="${book.id}">Share</button>
            <button class="dropdown-item" data-action="delete" data-book-id="${book.id}" style="color:#d32f2f;">Delete</button>
          </div>
        </div>
      </div>
    </div>`;
}

function getQuickActions(book){
  switch(book.status){
    case 'wish':    return `<button class="action-btn primary" data-action="start-reading" data-book-id="${book.id}">Start Reading</button>`;
    case 'reading': return `<button class="action-btn primary" data-action="finish-reading" data-book-id="${book.id}">Mark Complete</button>`;
    case 'read':    return `<button class="action-btn" data-action="rate" data-book-id="${book.id}">Rate Again</button>`;
    case 'upcoming':return `<button class="action-btn" data-action="wish" data-book-id="${book.id}">Add to Wishlist</button>`;
    default:        return '';
  }
}

/* ===== Stats ===== */
function updateStats(){
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  let monthCount = 0, yearCount = 0, totalRating = 0, ratedBooks = 0;
  books.forEach(book => {
    (book.sessions || []).forEach(session => {
      if(session.finishedAt) {
        const finishDate = new Date(session.finishedAt);
        if(finishDate.getFullYear() === currentYear) {
          yearCount++;
          if(finishDate.getMonth() === currentMonth) monthCount++;
        }
        if(session.rating > 0) { totalRating += session.rating; ratedBooks++; }
      }
    });
  });
  const completedBooks = books.filter(b => b.status === 'read').length;
  const avgRating = ratedBooks > 0 ? (totalRating / ratedBooks) : 0;
  document.getElementById('total-books').textContent = books.length.toString();
  document.getElementById('books-read').textContent = completedBooks.toString();
  document.getElementById('read-month').textContent = monthCount.toString();
  document.getElementById('read-year').textContent = yearCount.toString();
  document.getElementById('avg-rating').textContent = avgRating.toFixed(1);
}

/* ===== Filters & Search (local library) ===== */
function populateFilters(){
  const genres = [...new Set(books.map(b => b.genre).filter(Boolean))].sort();
  const genreSelect = document.getElementById('category-filter');
  genreSelect.innerHTML = '<option value="">All Genres</option>' + 
    genres.map(g => `<option value="${escapeAttr(g)}">${escapeHtml(g)}</option>`).join('');
  const tags = [...new Set(books.flatMap(b => b.tags || []))].sort();
  const tagSelect = document.getElementById('tag-filter');
  tagSelect.innerHTML = '<option value="">All Tags</option>' + 
    tags.map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join('');
}

function bookMatchesSearch(book, query){
  if(!query) return true;
  const searchText = query.toLowerCase();
  const searchFields = [
    book.title, book.author, book.synopsis, ...(book.tags || []), book.series?.name
  ].filter(Boolean).map(s => s.toLowerCase());
  return searchFields.some(field => field.includes(searchText));
}

let currentBooks = [];

function applyFilters(){
  const query = document.getElementById('search-input').value.trim();
  const tagFilter = document.getElementById('tag-filter').value;
  const genreFilter = document.getElementById('category-filter').value;
  const minRating = parseInt(document.getElementById('min-rating').value) || 0;
  const sortBy = document.getElementById('sort-by').value;

  let filtered = books.filter(book => {
    if(!bookMatchesSearch(book, query)) return false;
    if(tagFilter && !(book.tags || []).includes(tagFilter)) return false;
    if(genreFilter && book.genre !== genreFilter) return false;
    if(minRating > 0 && (book.rating || 0) < minRating) return false;
    return true;
  });

  switch(sortBy){
    case 'new':    filtered.sort((a,b) => new Date(b.addedAt) - new Date(a.addedAt)); break;
    case 'rating': filtered.sort((a,b) => (b.rating || 0) - (a.rating || 0)); break;
    case 'title':  filtered.sort((a,b) => a.title.localeCompare(b.title)); break;
    default:
      filtered.sort((a, b) => {
        const order = {reading:0, upcoming:1, wish:2, read:3};
        const ao=order[a.status] ?? 4, bo=order[b.status] ?? 4;
        return ao!==bo ? ao-bo : new Date(b.addedAt) - new Date(a.addedAt);
      });
  }

  currentBooks = filtered;
  renderBooks();
}

function renderBooks(){
  const container = document.getElementById('books-feed');
  if(currentBooks.length === 0){
    container.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--muted);">
      <h3 style="font-size:1.2rem;margin-bottom:12px;">No books found</h3>
      <p>Try adjusting your filters or search for new books to add.</p></div>`;
    document.getElementById('result-count').textContent = '0 books found';
    return;
  }
  const groups = {
    reading: currentBooks.filter(b => b.status === 'reading'),
    upcoming: currentBooks.filter(b => b.status === 'upcoming'),
    wish: currentBooks.filter(b => b.status === 'wish'),
    read: currentBooks.filter(b => b.status === 'read')
  };
  const names = { reading:'Currently Reading', upcoming:'Coming Soon', wish:'Want to Read', read:'Completed' };
  let html = '';
  Object.entries(groups).forEach(([status, arr]) => {
    if(arr.length === 0) return;
    html += `
      <div class="group-section">
        <h2 class="group-title">${names[status]} <span class="group-count">${arr.length}</span></h2>
        <div class="books-grid">${arr.map(renderBookCard).join('')}</div>
      </div>`;
  });
  container.innerHTML = html;
  document.getElementById('result-count').textContent = `${currentBooks.length} book${currentBooks.length === 1 ? '' : 's'} found`;
}

/* ===== External Search (Open Library + Google fallback) ===== */
const GBOOKS_API = 'https://www.googleapis.com/books/v1/volumes';
let searchResults = [];
let selectedResults = new Set();
let batchQueue = [];

function mapGenre(categories){
  if(!categories || !categories.length) return 'other';
  const cats = categories.join(' ').toLowerCase();
  const mappings = [
    ['mystery','mystery'],['thriller','thriller'],['horror','horror'],
    ['romance','romance'],['science fiction','sci-fi'],['fantasy','fantasy'],
    ['young adult','young adult'],['biography','biography'],['memoir','memoir'],
    ['self-help','self-help'],['history','history'],['business','business'],
    ['philosophy','philosophy'],['religion','spirituality/religion']
  ];
  for(const [needle, g] of mappings){ if(cats.includes(needle)) return g; }
  return cats.includes('fiction') ? 'fiction' : 'other';
}

function cleanTags(categories){
  if(!categories || !categories.length) return [];
  const stop = new Set(['fiction','nonfiction','non-fiction','books','literature','general','juvenile','adult','ages','book','novel','story','tales','the','and','or','of','in','at','by','for','with','to','from']);
  const words = categories.flatMap(cat => String(cat).split(/[\/\-|&,>()]+/))
    .map(w => w.trim().toLowerCase()).filter(w => w.length>2 && w.length<20 && !stop.has(w) && !/^\d+$/.test(w));
  return Array.from(new Set(words)).slice(0,8);
}

/* Open Library search */
async function searchOpenLibrary(title, author, limit=20){
  const qs = new URLSearchParams({ title, author, limit:String(limit) });
  const r = await fetch(`https://openlibrary.org/search.json?${qs.toString()}`);
  if(!r.ok) throw new Error('OpenLibrary failed');
  const data = await r.json();
  const docs = data.docs || [];
  return docs.map(d => {
    const cover = d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-M.jpg`
                : (Array.isArray(d.isbn) && d.isbn[0] ? `https://covers.openlibrary.org/b/isbn/${d.isbn[0]}-M.jpg` : '');
    const cats = Array.isArray(d.subject) ? d.subject.slice(0,10) : [];
    return {
      id: `ol_${d.key || Math.random()}`,
      title: d.title || '',
      authors: Array.isArray(d.author_name) ? d.author_name.join(', ') : (d.author_name || ''),
      description: d.first_sentence ? (Array.isArray(d.first_sentence) ? d.first_sentence[0] : d.first_sentence) : '',
      image: cover,
      categories: cats,
      publishedDate: d.first_publish_year ? String(d.first_publish_year) : '',
      averageRating: 0,
      ratingsCount: 0,
      language: Array.isArray(d.language) ? d.language[0] : '',
      pageCount: d.number_of_pages_median || 0,
      source: 'openlibrary'
    };
  });
}

/* Google fallback (fields cleaned & genre-agnostic) */
async function searchGoogleBooks(rawQuery, maxResults=20){
  const raw = String(rawQuery||'').trim();
  const titleOnly = raw.replace(/\binauthor:\s*("[^"]+"|[^\s]+)/ig,'').trim();
  const titleBoost = titleOnly ? (/\s/.test(titleOnly) ? `"${titleOnly}" OR intitle:"${titleOnly}"` : `intitle:${titleOnly}`) : '';
  const minus = ['-intitle:"study guide"','-intitle:"teacher guide"','-intitle:"summary"','-subject:drama','-subject:poetry'].join(' ');
  const q = [raw,titleBoost,minus].filter(Boolean).join(' ');
  const params = new URLSearchParams({
    q, maxResults:String(maxResults), printType:'books', orderBy:'relevance', langRestrict:'en',
    fields:'items(id,volumeInfo/title,volumeInfo/authors,volumeInfo/description,volumeInfo/categories,volumeInfo/imageLinks/thumbnail,volumeInfo/imageLinks/smallThumbnail,volumeInfo/publishedDate,volumeInfo/averageRating,volumeInfo/ratingsCount,volumeInfo/language,volumeInfo/pageCount),totalItems'
  });
  let resp = await fetch(`${GBOOKS_API}?${params.toString()}`);
  if(!resp.ok){
    const fb = new URLSearchParams({ q, maxResults:String(maxResults), printType:'books', orderBy:'relevance', langRestrict:'en' });
    resp = await fetch(`${GBOOKS_API}?${fb.toString()}`);
    if(!resp.ok) throw new Error('Google Books failed');
  }
  const data = await resp.json();
  const items = data.items || [];
  return items.map(item => {
    const info = item.volumeInfo||{};
    return {
      id: item.id,
      title: info.title||'',
      authors: Array.isArray(info.authors)? info.authors.join(', ') : (info.authors||''),
      description: info.description||'',
      image: info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '',
      categories: info.categories||[],
      publishedDate: info.publishedDate||'',
      averageRating: Number(info.averageRating||0),
      ratingsCount: Number(info.ratingsCount||0),
      language: info.language||'',
      pageCount: Number(info.pageCount||0),
      source: 'google'
    };
  });
}

/* Unified search */
async function performSearch(){
  const title = document.getElementById('ext-search-input').value.trim();
  const author = document.getElementById('ext-search-author').value.trim();
  if(!title) return;
  document.getElementById('search-results').innerHTML = '<div class="loading"></div>';

  try{
    let results = await searchOpenLibrary(title, author, 30);
    if(results.length === 0){
      const raw = author ? `${title} inauthor:"${author}"` : title;
      results = await searchGoogleBooks(raw, 20);
    }
    // Score & rank (tight title/author match, then popularity)
    const qTokens = (author ? `${title} ${author}` : title).toLowerCase().split(/\s+/).filter(Boolean);
    function score(r){
      const tl=r.title.toLowerCase(), al=r.authors.toLowerCase();
      let s=0;
      if(title && tl.includes(title.toLowerCase())) s+=30;
      s += qTokens.reduce((acc,t)=> acc + (tl.includes(t)?6:0) + (al.includes(t)?4:0), 0);
      const pop=(r.averageRating||0) * Math.log10((r.ratingsCount||0)+10); s+= pop*4;
      if(r.pageCount>0 && r.pageCount<40) s-=8;
      return s;
    }
    // Dedupe title+author
    const seen=new Map();
    for(const r of results){
      const key=`${(r.title||'').toLowerCase().replace(/[^\w\s]/g,'').trim()}::${(r.authors||'').toLowerCase().trim()}`;
      r.__score=score(r);
      if(!seen.has(key) || r.__score > seen.get(key).__score) seen.set(key,r);
    }
    searchResults = Array.from(seen.values()).sort((a,b)=> (b.__score||0)-(a.__score||0)).slice(0,20);
    selectedResults = new Set();
    renderSearchResults();
  }catch(e){
    document.getElementById('search-results').innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center;">Search failed. Please try again.</div>';
  }
}

function renderSearchResults(){
  const c = document.getElementById('search-results');
  if(searchResults.length===0){ c.innerHTML='<div style="color:var(--muted);padding:20px;text-align:center;">No results found</div>'; return; }
  c.innerHTML = searchResults.map((r,idx)=> {
    const year = r.publishedDate ? (r.publishedDate.split('-')[0]||'') : '';
    const tags = cleanTags(r.categories||[]);
    const gr = `https://www.goodreads.com/search?q=${encodeURIComponent((r.title||'')+' '+(r.authors||''))}`;
    return `
    <div class="result-item">
      <input type="checkbox" ${selectedResults.has(idx)?'checked':''} onchange="toggleResult(${idx})" style="margin-right:6px">
      ${r.image ? `<img src="${escapeAttr(r.image)}" class="result-cover">` : '<div class="result-cover" style="background:var(--line)"></div>'}
      <div class="result-info">
        <div class="result-title">${escapeHtml(r.title)}</div>
        <div class="result-meta">by ${escapeHtml(r.authors||'')} ${year?`• ${year}`:''} ${r.pageCount?`• ${r.pageCount}p`:''} ${r.source==='openlibrary'?'• OL':'• GB'}</div>
        ${tags.length? `<div class="result-tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`:''}
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="action-btn" href="${gr}" target="_blank" rel="noopener">Open on Goodreads</a>
          <button class="action-btn primary" onclick="openEditFromResult(${idx})" type="button">Edit & Add</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleResult(index){
  if(selectedResults.has(index)) selectedResults.delete(index);
  else selectedResults.add(index);
}

/* ===== Edit & Add flow ===== */
let editState = { rating:0, batch:[] };

function openEditFromResult(index){
  const r = searchResults[index]; if(!r) return;
  const tags = cleanTags(r.categories||[]);
  const genre = mapGenre(r.categories||[]);
  const goodreads = `https://www.goodreads.com/search?q=${encodeURIComponent((r.title||'')+' '+(r.authors||''))}`;
  document.getElementById('edit-title').value = r.title||'';
  document.getElementById('edit-author').value = r.authors||'';
  document.getElementById('edit-genre').value = genre;
  document.getElementById('edit-series').value = '';
  document.getElementById('edit-release').value = (toDateObj(r.publishedDate)||'') ? (toDateObj(r.publishedDate).toISOString().slice(0,10)) : '';
  document.getElementById('edit-synopsis').value = r.description||'';
  document.getElementById('edit-cover').src = r.image||'';
  document.getElementById('edit-cover-url').value = r.image||'';
  document.getElementById('edit-status').value = 'wish';
  document.getElementById('edit-goodreads-link').href = goodreads;

  // tags chips
  const wrap = document.getElementById('edit-tags-wrap'); wrap.innerHTML='';
  (tags||[]).forEach(t=> addTagChip(t));
  document.getElementById('edit-tags-input').value = '';

  // rating stars
  setupEditStars(0);
  toggleRatingVisibility();

  editState.current = { idx:index, base:r };
  document.getElementById('edit-modal').classList.add('show');
}

function addTagChip(val){
  val = String(val||'').trim(); if(!val) return;
  const chip = document.createElement('span');
  chip.className='chip';
  chip.textContent=val;
  chip.title='Click to remove';
  chip.style.cursor='pointer';
  chip.onclick=()=> chip.remove();
  document.getElementById('edit-tags-wrap').appendChild(chip);
}

function getTagsFromChips(){
  return Array.from(document.getElementById('edit-tags-wrap').querySelectorAll('.chip')).map(x=>x.textContent.trim()).filter(Boolean);
}

function setupEditStars(initial){
  const row = document.getElementById('edit-star-row'); row.innerHTML='';
  editState.rating = initial||0;
  for(let i=1;i<=5;i++){
    const b=document.createElement('button');
    b.className='star-btn';
    b.textContent='★';
    b.onclick=()=>{ editState.rating=i; updateEditStarDisplay(); };
    row.appendChild(b);
  }
  updateEditStarDisplay();
}

function updateEditStarDisplay(){
  const stars = document.querySelectorAll('#edit-star-row .star-btn');
  stars.forEach((s,idx)=> s.classList.toggle('active', idx < editState.rating));
}
function toggleRatingVisibility(){
  const show = document.getElementById('edit-status').value === 'read';
  document.getElementById('edit-rating-wrap').style.display = show ? 'block' : 'none';
}

function closeEditModal(){ document.getElementById('edit-modal').classList.remove('show'); }

/* Save from Edit modal */
function saveEditedBook(){
  const watchSeries = document.getElementById('ext-watch').checked;
  const title  = document.getElementById('edit-title').value.trim();
  const author = document.getElementById('edit-author').value.trim();
  const genre  = document.getElementById('edit-genre').value.trim()||'other';
  const seriesName = document.getElementById('edit-series').value.trim();
  const release = document.getElementById('edit-release').value.trim();
  const synopsis = document.getElementById('edit-synopsis').value.trim();
  const image = document.getElementById('edit-cover-url').value.trim();
  const status = document.getElementById('edit-status').value;
  const rating = (status==='read') ? editState.rating||0 : 0;
  const tags = getTagsFromChips();

  const book = newBook({
    title, author, image, synopsis,
    genre, tags,
    status, releaseDate: release||'',
    series: seriesName ? { name: seriesName } : null,
    rating
  });
  books.unshift(book);
  if(watchSeries && seriesName){ sitePrefs.watchSeries[seriesName] = author; }

  saveAll(); populateFilters(); applyFilters(); updateStats();
  showToast(`Added "${title}"`);
  closeEditModal();

  // Continue batch if queued
  if(editState.batch && editState.batch.length){
    const nextIdx = editState.batch.shift();
    openEditFromResult(nextIdx);
  }
}

/* Batch: Add Selected → edit each in order */
function addSelectedBooks(){
  const selected = Array.from(selectedResults);
  if(selected.length===0) return;
  editState.batch = selected.slice(1); // queue the rest
  openEditFromResult(selected[0]);
}

/* ===== Find Similar ===== */
function findSimilarBooks(book){
  const searchTerms=[];
  if(book.tags && book.tags.length){
    const good=book.tags.filter(t=> t.length>3 && !['other','general','book','books','fiction','nonfiction'].includes(t));
    searchTerms.push(...good.slice(0,2));
  }
  if(book.genre && !['other','fiction'].includes(book.genre)) searchTerms.push(book.genre.replace(/-/g,' '));
  const fallbackMap={mystery:'mystery crime detective',thriller:'thriller suspense',romance:'romance love story',fantasy:'fantasy magic adventure','sci-fi':'science fiction space',horror:'horror supernatural scary',biography:'biography life',memoir:'memoir',history:'history',business:'business leadership','self-help':'self help',philosophy:'philosophy ideas','spirituality/religion':'religion spiritual'};
  if(!searchTerms.length) searchTerms.push(fallbackMap[book.genre]||'popular books');
  const q = searchTerms.join(' ');
  openSearchModal(q);
  showToast(`Searching for books like this…`);
}

/* ===== Release Checking ===== */
async function checkReleases(){
  const watchedSeries = Object.keys(sitePrefs.watchSeries || {});
  if(watchedSeries.length === 0){ showToast('No series being watched'); return; }
  let found=0;
  for(const seriesName of watchedSeries){
    try{
      const author = sitePrefs.watchSeries[seriesName] || '';
      const data = await searchGoogleBooks(`"${seriesName}" ${author?`inauthor:"${author}"`:''}`, 20);
      const now=new Date();
      const upcoming=(data||[]).map(i=>({title:i.title, dt: toDateObj(i.publishedDate)}))
         .filter(x=> x.dt && x.dt>now).sort((a,b)=>a.dt - b.dt);
      if(upcoming.length){ showToast(`${seriesName}: "${upcoming[0].title}" releasing ${formatDate(upcoming[0].dt)}`); found++; }
    }catch(e){ console.warn(e); }
  }
  if(!found) showToast('No upcoming releases found');
}

/* ===== Initialization & Events ===== */
let currentRatingBook=null, currentRating=0;

function openSearchModal(query=''){
  document.getElementById('ext-search-input').value = query;
  document.getElementById('ext-search-author').value = '';
  document.getElementById('ext-watch').checked = false;
  document.getElementById('search-results').innerHTML = '';
  document.getElementById('search-modal').classList.add('show');
  if(query) performSearch();
}
function closeSearchModal(){ document.getElementById('search-modal').classList.remove('show'); }

function openRatingModal(book){
  currentRatingBook = book;
  currentRating = book.rating || 0;
  document.getElementById('finish-title').textContent = `${book.title} by ${book.author}`;
  const container = document.getElementById('star-rating'); container.innerHTML = '';
  for(let i=1;i<=5;i++){
    const star=document.createElement('button');
    star.className='star-btn'; star.textContent='★'; star.onclick=()=> setRating(i);
    container.appendChild(star);
  }
  updateStarDisplay();
  document.getElementById('finish-modal').classList.add('show');
}
function setRating(r){ currentRating=r; updateStarDisplay(); }
function updateStarDisplay(){ document.querySelectorAll('.star-btn').forEach((s,i)=> s.classList.toggle('active', i<currentRating)); }
function closeRatingModal(){ document.getElementById('finish-modal').classList.remove('show'); currentRatingBook=null; currentRating=0; }
function saveRating(){
  if(!currentRatingBook) return;
  const book = books.find(b=>b.id===currentRatingBook.id); if(!book) return;
  book.rating=currentRating;
  if(book.status!=='read'){ if(book.status!=='reading') startReading(book); finishReading(book,currentRating); }
  else { const last=book.sessions[book.sessions.length-1]; if(last) last.rating=currentRating; }
  saveAll(); applyFilters(); updateStats(); closeRatingModal(); showToast('Rating saved!');
}

/* Export/Import */
function exportCSV(){
  const headers=['Title','Author','Genre','Rating','Status','Tags','Added Date'];
  const rows=books.map(b=>[b.title,b.author,b.genre,b.rating||0,b.status,(b.tags||[]).join('; '),formatDate(b.addedAt)]);
  const csv=[headers,...rows].map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadFile('plotline-books.csv', csv, 'text/csv');
}
function exportJSON(){ const data=JSON.stringify({books,sitePrefs},null,2); downloadFile('plotline-export.json', data, 'application/json'); }
function downloadFile(filename, content, type){
  const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob);
  const link=document.createElement('a'); link.href=url; link.download=filename; document.body.appendChild(link); link.click();
  document.body.removeChild(link); URL.revokeObjectURL(url);
}
function importJSON(file){
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(data.books) books=data.books;
      if(data.sitePrefs) sitePrefs=Object.assign({watchSeries:{}}, data.sitePrefs);
      saveAll(); populateFilters(); applyFilters(); updateStats(); loadGoalsUI(); showToast('Import successful!');
    }catch(_){ showToast('Invalid JSON file', true); }
  };
  reader.readAsText(file);
}

/* Goals */
function loadGoalsUI(){
  const g=sitePrefs.goals||{};
  document.getElementById('goal-year').value = g.year || new Date().getFullYear();
  document.getElementById('goal-total').value = g.total || 0;
  document.getElementById('goal-catholic').value = (g.byTag && g.byTag.catholic) || 0;
  document.getElementById('goal-fiction').value = (g.byTag && g.byTag.fiction) || 0;
  document.getElementById('goal-nonfiction').value = (g.byTag && g.byTag.nonfiction) || 0;
  updateWatchedSeriesList();
}
function updateWatchedSeriesList(){
  const container=document.getElementById('watched-series-list');
  const ws=sitePrefs.watchSeries||{}; const names=Object.keys(ws);
  if(names.length===0){ container.innerHTML='<div class="chip">No series being watched</div>'; return; }
  container.innerHTML=names.map(name=>{
    const author=ws[name]||'';
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px;background:var(--paper-2);border-radius:8px;border:1px solid var(--line);">
      <strong style="flex:1;">${escapeHtml(name)}</strong>
      ${author? `<span style="color:var(--muted);font-size:13px;">by ${escapeHtml(author)}</span>`:''}
      <button class="action-btn" onclick="removeWatchedSeries('${escapeAttr(name)}')" style="padding:4px 8px;font-size:12px;">Remove</button>
    </div>`;
  }).join('');
}
function removeWatchedSeries(seriesName){ delete sitePrefs.watchSeries[seriesName]; saveAll(); updateWatchedSeriesList(); showToast(`Stopped watching "${seriesName}"`); }
function saveGoals(){
  const g=sitePrefs.goals||{};
  g.year = parseInt(document.getElementById('goal-year').value) || new Date().getFullYear();
  g.total = parseInt(document.getElementById('goal-total').value) || 0;
  g.byTag = g.byTag || {};
  g.byTag.catholic = parseInt(document.getElementById('goal-catholic').value) || 0;
  g.byTag.fiction = parseInt(document.getElementById('goal-fiction').value) || 0;
  g.byTag.nonfiction = parseInt(document.getElementById('goal-nonfiction').value) || 0;
  sitePrefs.goals=g; saveAll(); showToast('Goals saved successfully!');
}

/* Book actions */
function handleBookAction(action, bookId){
  const book = books.find(b => b.id === parseInt(bookId)); if(!book) return;
  switch(action){
    case 'wish': setWish(book); saveAll(); applyFilters(); updateStats(); showToast('Moved to wishlist'); break;
    case 'start-reading': startReading(book); saveAll(); applyFilters(); updateStats(); showToast('Started reading!'); break;
    case 'finish-reading': openRatingModal(book); break;
    case 'rate': openRatingModal(book); break;
    case 'edit': editBook(book); break;
    case 'delete':
      if(confirm(`Delete "${book.title}"?`)){ books = books.filter(b => b.id !== book.id); saveAll(); applyFilters(); updateStats(); showToast('Book deleted'); }
      break;
    case 'find-similar': findSimilarBooks(book); break;
    case 'share': shareBook(book); break;
    case 'toggle-synopsis': toggleSynopsis(bookId); break;
    case 'toggle-menu': toggleDropdownMenu(bookId); break;
  }
}

function editBook(book){
  const newTitle = prompt('Edit title:', book.title); if(newTitle===null) return;
  const newAuthor = prompt('Edit author:', book.author); if(newAuthor===null) return;
  book.title = newTitle.trim() || book.title;
  book.author = newAuthor.trim() || book.author;
  saveAll(); applyFilters(); showToast('Book updated');
}

function shareBook(book){
  const goodreadsUrl = `https://www.goodreads.com/search?q=${encodeURIComponent(book.title + ' ' + book.author)}`;
  const rating = book.rating > 0 ? ` • ${book.rating}★` : '';
  const text = `"${book.title}" by ${book.author}${rating} - Check it out: ${goodreadsUrl}`;
  if(navigator.share){
    navigator.share({ title:'Book Recommendation', text }).catch(()=>{
      if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
        const smsUrl = isiOS() ? `sms:&body=${encodeURIComponent(text)}` : `sms:?body=${encodeURIComponent(text)}`;
        window.open(smsUrl);
      }else{ copyToClipboard(text); showToast('Book link copied to clipboard!'); }
    });
  }else{
    if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
      const smsUrl = isiOS() ? `sms:&body=${encodeURIComponent(text)}` : `sms:?body=${encodeURIComponent(text)}`;
      window.open(smsUrl);
    }else{ copyToClipboard(text); showToast('Book recommendation copied to clipboard!'); }
  }
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=> showToast('Copied to clipboard!')).catch(()=> showToast('Could not copy to clipboard', true));
}

function toggleSynopsis(bookId){
  const synopsis=document.querySelector(`[data-book-id="${bookId}"] .book-synopsis`); if(!synopsis) return;
  const text=synopsis.querySelector('.synopsis-text'); const btn=synopsis.querySelector('.synopsis-toggle'); if(!text||!btn) return;
  const book=books.find(b=>b.id===parseInt(bookId)); if(!book||!book.synopsis) return;
  const isExpanded=synopsis.classList.contains('expanded');
  if(isExpanded){ synopsis.classList.remove('expanded'); text.textContent = truncate(book.synopsis, 150); btn.textContent='Read more'; }
  else { synopsis.classList.add('expanded'); text.textContent=book.synopsis; btn.textContent='Show less'; }
}
function toggleDropdownMenu(bookId){
  document.querySelectorAll('.dropdown').forEach(m=>{ if(m.dataset.bookId!==bookId) m.classList.remove('show','left'); });
  const menu=document.querySelector(`.dropdown[data-book-id="${bookId}"]`); if(!menu) return;
  const isShowing=menu.classList.contains('show');
  if(isShowing){ menu.classList.remove('show','left'); }
  else {
    menu.classList.remove('left'); menu.classList.add('show'); menu.offsetWidth;
    requestAnimationFrame(()=>{ const rect=menu.getBoundingClientRect(), vw=window.innerWidth, sw=window.innerWidth-document.documentElement.clientWidth;
      if(rect.right > vw - sw - 20) menu.classList.add('left'); });
  }
}

/* ===== Initialize ===== */
function initializeApp(){
  // Manifest
  try{
    const manifest={ name:'PlotLine', short_name:'PlotLine', start_url:'./', display:'standalone',
      background_color:'#f4f1ea', theme_color:'#2f4a3e',
      icons:[{src:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABQFZ1hAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE=', sizes:'192x192', type:'image/png'}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const url=URL.createObjectURL(blob); const link=document.getElementById('app-manifest'); if(link) link.href=url;
  }catch(e){ console.warn('Manifest failed',e); }

  loadAll().then(()=>{ populateFilters(); applyFilters(); updateStats(); loadGoalsUI(); });

  // Navigation
  document.getElementById('feed-btn').addEventListener('click', ()=>{ openSection('feed'); applyFilters(); });
  document.getElementById('prefs-btn').addEventListener('click', ()=> openSection('prefs'));

  // Search & filters
  document.getElementById('search-input').addEventListener('input', applyFilters);
  document.getElementById('tag-filter').addEventListener('change', applyFilters);
  document.getElementById('category-filter').addEventListener('change', applyFilters);
  document.getElementById('min-rating').addEventListener('change', applyFilters);
  document.getElementById('sort-by').addEventListener('change', applyFilters);
  document.getElementById('collapse-synopsis').addEventListener('change', renderBooks);

  // Add book / releases
  document.getElementById('add-book-btn').addEventListener('click', ()=> openSearchModal());
  document.getElementById('check-releases-btn').addEventListener('click', checkReleases);

  // Search modal events
  document.getElementById('ext-search-btn').addEventListener('click', performSearch);
  document.getElementById('ext-close').addEventListener('click', closeSearchModal);
  ['ext-search-input','ext-search-author'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); performSearch(); } }); }
  });
  document.getElementById('ext-select-all').addEventListener('click', ()=>{
    selectedResults = new Set(searchResults.map((_,i)=>i)); renderSearchResults();
  });
  document.getElementById('ext-add-selected').addEventListener('click', addSelectedBooks);

  // Edit modal events
  document.getElementById('edit-status').addEventListener('change', toggleRatingVisibility);
  document.getElementById('edit-cover-url').addEventListener('input', e=>{
    const url=e.target.value.trim(); document.getElementById('edit-cover').src = url || '';
  });
  document.getElementById('edit-tags-input').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); const v=e.target.value.trim(); if(v){ addTagChip(v); e.target.value=''; } }
  });
  document.getElementById('edit-save').addEventListener('click', saveEditedBook);
  document.getElementById('edit-cancel').addEventListener('click', closeEditModal);

  // Rating modal
  document.getElementById('finish-save').addEventListener('click', saveRating);
  document.getElementById('finish-cancel').addEventListener('click', closeRatingModal);

  // Goals
  document.getElementById('save-goals').addEventListener('click', saveGoals);

  // Export/Import
  document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
  document.getElementById('export-json-btn').addEventListener('click', exportJSON);
  document.getElementById('import-json').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });

  // Cloud sync
  document.getElementById('cloud-save').addEventListener('click', ()=>{
    const apiKey=document.getElementById('cloud-api').value.trim();
    const binId=document.getElementById('cloud-bin').value.trim();
    if(apiKey) localStorage.setItem('plotline_api_key', apiKey);
    if(binId) localStorage.setItem('plotline_bin_id', binId);
    showToast('Cloud settings saved');
  });
  document.getElementById('cloud-create').addEventListener('click', cloudCreate);
  document.getElementById('cloud-pull').addEventListener('click', cloudPull);
  document.getElementById('cloud-push').addEventListener('click', cloudPush);

  // Global click handler
  document.addEventListener('click', (e)=>{
    const actionBtn=e.target.closest('[data-action]');
    if(actionBtn){
      const action=actionBtn.dataset.action; const bookId=actionBtn.dataset.bookId;
      if(action && bookId){ e.preventDefault(); e.stopPropagation(); handleBookAction(action, bookId); return; }
    }
    if(!e.target.closest('.more-menu')) document.querySelectorAll('.dropdown.show').forEach(m=> m.classList.remove('show','left'));
    if(e.target.classList.contains('modal')){
      if(e.target.id==='finish-modal') closeRatingModal();
      if(e.target.id==='search-modal') closeSearchModal();
      if(e.target.id==='edit-modal') closeEditModal();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      document.querySelectorAll('.modal.show').forEach(m=> m.classList.remove('show'));
      document.querySelectorAll('.dropdown.show').forEach(menu=> menu.classList.remove('show'));
    }
    if((e.ctrlKey||e.metaKey) && e.key==='k'){ e.preventDefault(); document.getElementById('search-input').focus(); }
  });
}

function openSection(id){
  document.querySelectorAll('.section').forEach(s=> s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=> b.classList.remove('active'));
  document.getElementById(`${id}-btn`).classList.add('active');
}

/* Cloud helpers exposed */
async function cloudPull(){ document.getElementById('sync-status').textContent='Pulling...'; await loadAll(); applyFilters(); updateStats(); showToast('Data pulled from cloud'); }
async function cloudPush(){ try{ document.getElementById('sync-status').textContent='Pushing...'; await saveAll(); showToast('Data pushed to cloud'); }catch(e){ document.getElementById('sync-status').textContent='Sync failed'; showToast(e.message||'Push failed',true); } }
async function cloudCreate(){
  try{
    document.getElementById('sync-status').textContent = 'Creating...';
    const initial = { plotline: { books, sitePrefs } };
    const r=await fetch(`${getApiBase()}/b`,{method:'POST',headers: jbHeaders(),body:JSON.stringify(initial)});
    if(!r.ok){ const txt = await r.text(); throw new Error(`Create ${r.status}: ${txt.slice(0,140)}`); }
    const data=await r.json();
    const newId=(data.metadata && data.metadata.id)||data.id;
    if(!newId) throw new Error('No Bin ID returned');
    localStorage.setItem('plotline_bin_id', newId);
    document.getElementById('cloud-bin').value = newId;
    showToast('New JSONBin created: '+newId);
    document.getElementById('sync-status').textContent='Created';
  }catch(e){ console.warn(e); document.getElementById('sync-status').textContent='Create failed'; showToast(e.message||'Create failed',true); }
}

/* Global hooks */
window.toggleResult = toggleResult;
window.openEditFromResult = openEditFromResult;
window.removeWatchedSeries = removeWatchedSeries;

if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initializeApp); }
else { initializeApp(); }
</script>
</body>
</html>
