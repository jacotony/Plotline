<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PlotLine — Series-Aware</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --ink:#e6e8ec; --muted:#9aa3ab;
    --line:#232735; --accent:#86e1a0; --chip:#202535; --warn:#f0c674;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent)}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .row{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 8px}
  .input,.select,.textarea{width:100%;padding:10px;border-radius:8px;background:#0b0d12;border:1px solid var(--line);color:var(--ink)}
  .textarea{min-height:110px;resize:vertical}
  .btn{background:#222a3a;border:1px solid #2b3248;color:#e9ecf2;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:#1d2b22;border-color:#2b4a39}
  .btn.warn{background:#332b14;border-color:#5b4d1c;color:#f5e6b3}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--line);background:#0b0d12;border-radius:999px;padding:4px 10px;color:var(--muted)}
  .grid{display:grid;gap:10px}
  .lib{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .card{background:#12151c;border:1px solid var(--line);border-radius:12px;padding:10px;display:grid;gap:6px}
  .title{font-weight:800}
  .meta{color:var(--muted);font-size:12px}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{background:var(--chip);color:#c8cfe0;border:1px solid #2a3040;border-radius:999px;font-size:12px;padding:2px 8px}
  .cover{width:72px;height:108px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#0b0d12}
  .flex{display:flex;gap:10px}
  .grow{flex:1}
  .right{margin-left:auto}
  .small{font-size:12px;color:var(--muted)}
  .result{display:flex;gap:10px;align-items:flex-start;padding:8px;border-bottom:1px solid #1d2130}
  .result:hover{background:#121723}
  .results{position:absolute;left:0;right:0;top:100%;z-index:20;background:#0b0f18;border:1px solid #1d2130;border-radius:10px;max-height:360px;overflow:auto}
  .chipline{display:flex;gap:6px;flex-wrap:wrap}
  .badge{background:#203226;border:1px solid #2b4a39;color:#bfe8cc;border-radius:6px;padding:2px 6px;font-size:11px}
  .series-box{border:1px dashed #2a3040;border-radius:10px;padding:10px;margin-top:8px;background:#0e131d}
  .series-list .result{padding:6px}
  .inline{display:inline-block}
  .warn{color:var(--warn)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .sp{height:8px}
  .btnbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media (max-width:900px){ .row{grid-template-columns:1fr} .lib{grid-template-columns:1fr 1fr} }
  @media (max-width:620px){ .lib{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>PlotLine</h1>

    <div class="row">
      <!-- ADD / PICK -->
      <section class="panel">
        <h2>Add book</h2>
        <div class="grid">
          <div style="position:relative">
            <input id="search" class="input" placeholder="Search title / author (Google Books, English only)…" autocomplete="off"/>
            <div id="results" class="results" style="display:none"></div>
          </div>

          <div id="picked" class="grid" style="display:none">
            <div class="flex">
              <img id="picked-cover" class="cover" alt="">
              <div class="grow">
                <div id="picked-title" class="title"></div>
                <div id="picked-auth" class="meta"></div>
                <div id="picked-series" class="meta"></div>
                <div id="picked-date" class="meta"></div>
                <div id="picked-cats" class="meta"></div>
              </div>
            </div>

            <div class="row2">
              <div>
                <label class="small">Status</label>
                <select id="picked-status" class="select">
                  <option value="wish">Want to Read</option>
                  <option value="reading">Currently Reading</option>
                  <option value="read">Read</option>
                </select>
              </div>
              <div>
                <label class="small">Release date (auto if future)</label>
                <input id="picked-release" class="input" placeholder="YYYY-MM-DD"/>
              </div>
            </div>

            <div>
              <label class="small">Synopsis</label>
              <textarea id="picked-desc" class="textarea"></textarea>
            </div>

            <div>
              <div class="bar">
                <div class="small">Recommended Tags</div>
                <button id="regen-tags" class="btn small">Regenerate</button>
              </div>
              <div id="reco-tags" class="chipline" style="margin-top:6px"></div>
              <div class="sp"></div>
              <label class="small">Your Tags (edit)</label>
              <input id="picked-tags" class="input" placeholder="comma, separated, tags"/>
            </div>

            <div class="btnbar">
              <button id="add-picked" class="btn primary">Add Book</button>
              <button id="clear-picked" class="btn">Clear</button>
              <span id="picked-upcoming-note" class="small"></span>
            </div>

            <div id="series-suggestions" class="series-box" style="display:none">
              <div class="bar" style="justify-content:space-between">
                <strong>Series volumes by this author</strong>
                <button id="add-selected-series" class="btn small">Add Selected</button>
              </div>
              <div id="series-note" class="small" style="margin:6px 0 8px;color:#aeb6c7"></div>
              <div id="series-list" class="series-list"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- LIBRARY -->
      <section class="panel">
        <div class="bar" style="justify-content:space-between">
          <h2 style="margin:0">Library</h2>
          <div class="btnbar">
            <button id="filter-all" class="btn small">All</button>
            <button id="filter-wish" class="btn small">Wish</button>
            <button id="filter-reading" class="btn small">Reading</button>
            <button id="filter-read" class="btn small">Read</button>
            <button id="filter-upcoming" class="btn small warn">Upcoming</button>
            <button id="export-json" class="btn small">Export JSON</button>
          </div>
        </div>
        <div id="lib" class="lib" style="margin-top:10px"></div>
      </section>
    </div>
  </div>

<script>
/* ================== Helpers ================== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const escapeHtml = s => String(s??'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
const rAll = (s,a,b)=>String(s).split(a).join(b);
function debounced(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }
function normalizeTag(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9 +]/g,' ').replace(/\s+/g,' ').trim().replace(/\s/g,'-'); }
function uniqPush(arr, t){ t=normalizeTag(t); if(t && !arr.includes(t)) arr.push(t); return arr; }
function toDateObj(v){
  if(!v) return null;
  // Google can return "YYYY", "YYYY-MM", or "YYYY-MM-DD"
  const parts = String(v).split('-');
  if(parts.length===1) return new Date(parts[0], 0, 1);
  if(parts.length===2) return new Date(parts[0], parts[1]-1, 1);
  return new Date(parts[0], parts[1]-1, parts[2]);
}

/* ================== State ================== */
let library = []; // {id,title,author,image,tags,status,releaseDate,series:{name,number},synopsis,genre}
let filter = 'all';
let lastSearchItems = [];
let picked = null;
let pickedSeriesCandidates = []; // array of mapped items for series
const GBOOKS_API = 'https://www.googleapis.com/books/v1/volumes';

/* ================== Tagging ================== */
function cleanTags(categories) {
  if(!categories || !categories.length) return [];
  const stop = new Set(['fiction','nonfiction','non-fiction','books','literature','general','juvenile','adult','book','novel','story','tales','the','and','or','of','in','at','by','for','with','to','from']);
  const out = [];
  (categories||[]).forEach(cat=>{
    cat.split(/[\/\-|&,>()]+/).forEach(w=>{
      w = normalizeTag(w);
      if(w.length>3 && w.length<24 && !stop.has(w) && !/^\d+$/.test(w)) uniqPush(out, w);
    });
  });
  const joined = (categories||[]).join(' | ').toLowerCase();
  if(/science fiction/.test(joined)) uniqPush(out,'sci-fi');
  if(/young adult|ya\b/i.test(joined)) uniqPush(out,'young-adult');
  if(/historical/.test(joined)) uniqPush(out,'historical-fiction');
  return out.slice(0,8);
}
function extractTagsFromText(text){
  const s = String(text||'').toLowerCase();
  const tags = [];
  const KEYS = [
    [/academy|academia|boarding school|campus/,'elite-academy'],
    [/politic|senator|consul|minister|court intrigue|statecraft/,'political-fantasy'],
    [/spy|spying|espionage|infiltrat|undercover|agent/,'espionage'],
    [/roman|legion|imperial|caesar|julii|quintus|senator/,'roman-inspired'],
    [/hierarch|caste|noble|rank|class system/,'social-hierarchy'],
    [/corrupt|corruption|bribe|cover[- ]?up|rot/,'corruption'],
    [/conspiracy|cabal|plotting|hidden agenda|shadowy|scheme/,'conspiracy'],
    [/morally\s*gray|anti[- ]?hero/,'morally-gray-hero'],
    [/twist|twisty|reveal|double[- ]?cross|secrets|what happened/,'twisty-plot'],
    [/murder|whodunnit|whodunit|investigation|detective/,'mystery'],
    [/magic|mage|wizard|sorcer|fae|arcane/,'fantasy'],
  ];
  KEYS.forEach(([re,tag])=>{ if(re.test(s)) uniqPush(tags, tag); });
  const hasAcademy = /academy|academia|boarding school|campus/.test(s);
  const intrigueish = /(hidden agenda|conspiracy|plot|plotting|scheme|secrets|intrigue)/.test(s);
  if(hasAcademy && intrigueish) uniqPush(tags,'academy-intrigue');
  if(hasAcademy && /(dark|gothic|grim|murder|death|secret)/.test(s)) uniqPush(tags,'dark-academia');
  return tags.slice(0,12);
}
function recommendTagsFrom(title, synopsis, categories){
  const out = [];
  cleanTags(categories||[]).forEach(t=>uniqPush(out,t));
  extractTagsFromText(`${title||''} ${synopsis||''}`).forEach(t=>uniqPush(out,t));
  const priority = new Set(['dark-academia','academy-intrigue','political-fantasy','espionage','roman-inspired','social-hierarchy','corruption','conspiracy','morally-gray-hero','twisty-plot']);
  out.sort((a,b)=> (priority.has(a)?0:1) - (priority.has(b)?0:1) || a.localeCompare(b) );
  if(!out.length && String(title||synopsis||'').trim()){
    ['mystery','thriller','political-fantasy','conspiracy','twisty-plot'].forEach(t=>uniqPush(out,t));
  }
  return out.slice(0,12);
}

/* ================== Google Books (English only) ================== */
async function searchGoogleBooks(query, maxResults=12){
  const url = `${GBOOKS_API}?q=${encodeURIComponent(query)}&maxResults=${maxResults}&printType=books&langRestrict=en&fields=items(id,volumeInfo(title,authors,description,categories,imageLinks,language,publishedDate,averageRating,ratingsCount,pageCount))`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Search failed');
  return await r.json();
}

/* ================== Series parsing & matching ================== */
function parseSeriesFromTitle(title=''){
  const t = String(title);
  // Patterns:
  //   "Title (Series Name #2)"  | "Title (Series Name Book 2)" | "Title — Series Name #3"
  //   "Title: Series Name #1"   | "Title [Series Name #4]"
  //   "Title (Book 2 of Series Name)"
  const patterns = [
    /\(([^)]+?)\s*#\s*(\d+)\)/i,
    /\(([^)]+?)\s*book\s*(\d+)\)/i,
    /—\s*([^—]+?)\s*#\s*(\d+)/i,
    /:\s*([^:]+?)\s*#\s*(\d+)/i,
    /\[([^\]]+?)\s*#\s*(\d+)\]/i,
    /\(book\s*(\d+)\s*of\s*([^)]+)\)/i // number first
  ];
  for(const re of patterns){
    const m = t.match(re);
    if(m){
      if(re===patterns[5]){ // "(Book 2 of Series)"
        const num = Number(m[1]); const name = m[2].trim();
        return { name, number: isFinite(num)?num:null };
      }else{
        const name = (m[1]||m[2]||'').trim();
        const num = Number(m[2]||m[1]);
        return { name, number: isFinite(num)?num:null };
      }
    }
  }
  // Sometimes "Series Name, #2" appended
  const m2 = t.match(/,\s*([^,]+?)\s*#\s*(\d+)/i);
  if(m2) return { name:m2[1].trim(), number:Number(m2[2])||null };
  return null;
}
function normSeriesName(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,' ').trim(); }

async function findSeriesMatesByAuthorAndSeries(primaryItem){
  const authors = primaryItem.authors?.split(',').map(s=>s.trim()).filter(Boolean) || [];
  const firstAuthor = authors[0] || '';
  const ps = parseSeriesFromTitle(primaryItem.title);
  if(!firstAuthor || !ps) return [];

  const seriesName = ps.name;
  // query targeted to same series + author, English
  const q = `intitle:"${seriesName}" inauthor:"${firstAuthor}"`;
  const url = `${GBOOKS_API}?q=${encodeURIComponent(q)}&maxResults=20&printType=books&langRestrict=en&fields=items(id,volumeInfo(title,authors,description,categories,imageLinks,language,publishedDate,averageRating,ratingsCount,pageCount))`;
  const r = await fetch(url);
  if(!r.ok) return [];
  const data = await r.json();

  const wantSeries = normSeriesName(seriesName);
  const mapped = (data.items||[]).map(it=>{
    const v = it.volumeInfo||{};
    const ser = parseSeriesFromTitle(v.title||'');
    return {
      id: it.id,
      title: v.title||'',
      authors: (v.authors||[]).join(', '),
      image: v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || '',
      description: v.description||'',
      categories: v.categories||[],
      publishedDate: v.publishedDate||'',
      averageRating: v.averageRating||0,
      ratingsCount: v.ratingsCount||0,
      series: ser
    };
  }).filter(x=>{
    if(!x.series) return false;
    return normSeriesName(x.series.name) === wantSeries && (x.authors||'').toLowerCase().includes(firstAuthor.toLowerCase());
  });

  // Remove the one we just picked, dedupe by title
  const pickedTitle = (primaryItem.title||'').toLowerCase();
  const seenTitle = new Set();
  const unique = mapped.filter(m=>{
    const k = (m.title||'').toLowerCase();
    if(k===pickedTitle) return false;
    if(seenTitle.has(k)) return false;
    seenTitle.add(k); return true;
  });

  // sort by series # if present, else by date
  unique.sort((a,b)=>{
    const an = a.series?.number ?? 1e9;
    const bn = b.series?.number ?? 1e9;
    if(an!==bn) return an-bn;
    const ad = toDateObj(a.publishedDate)?.getTime() ?? 0;
    const bd = toDateObj(b.publishedDate)?.getTime() ?? 0;
    return ad - bd;
  });

  return unique;
}

/* ================== Library render ================== */
function renderLibrary(){
  const c = $('#lib');
  const list = library.filter(b=>{
    if(filter==='all') return true;
    if(filter==='upcoming') return b.status==='upcoming';
    return b.status===filter;
  });
  if(!list.length){ c.innerHTML = '<div class="small">No books.</div>'; return; }
  c.innerHTML = list.map(b=>`
    <div class="card">
      <div class="flex">
        ${b.image?`<img src="${escapeHtml(b.image)}" class="cover" alt="">`:`<div class="cover"></div>`}
        <div class="grow">
          <div class="title">${escapeHtml(b.title)}</div>
          <div class="meta">by ${escapeHtml(b.author||'')}</div>
          <div class="meta">${b.series?`Series: ${escapeHtml(b.series.name)}${b.series.number?` #${b.series.number}`:''}`:`Standalone`}</div>
          <div class="meta">
            ${b.status==='upcoming' ? `<span class="badge">Upcoming</span> ${b.releaseDate?`• Releases ${escapeHtml(b.releaseDate)}`:''}` : `<span class="badge">${escapeHtml(b.status)}</span>`}
          </div>
        </div>
      </div>
      <div class="meta">Published: ${escapeHtml(b.publishedDate||'-')}</div>
      ${b.synopsis?`<div class="small">${escapeHtml(b.synopsis)}</div>`:''}
      <div class="tags">
        ${(b.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}
      </div>
    </div>
  `).join('');
}

/* ================== Search UI ================== */
const doLiveSearch = debounced(async ()=>{
  const q = $('#search').value.trim();
  const box = $('#results');
  if(q.length<2){ box.style.display='none'; box.innerHTML=''; return; }
  try{
    const data = await searchGoogleBooks(q, 12);
    lastSearchItems = (data.items||[]).map(item=>{
      const v = item.volumeInfo||{};
      const cats = v.categories||[];
      return {
        id: item.id,
        title: v.title||'Unknown Title',
        authors: (v.authors||[]).join(', '),
        description: v.description||'',
        image: v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || '',
        categories: cats,
        publishedDate: v.publishedDate||'',
        series: parseSeriesFromTitle(v.title||''),
        averageRating: v.averageRating||0,
        ratingsCount: v.ratingsCount||0,
        language: v.language||'en',
        recoTags: recommendTagsFrom(v.title, v.description, cats)
      };
    });
    if(!lastSearchItems.length){ box.innerHTML = `<div class="small" style="padding:10px">No results</div>`; box.style.display='block'; return; }
    box.innerHTML = lastSearchItems.map((r,i)=>`
      <div class="result" data-pick="${i}">
        ${r.image?`<img src="${escapeHtml(r.image)}" class="cover" alt="">`:`<div class="cover"></div>`}
        <div class="grow">
          <div><strong>${escapeHtml(r.title)}</strong></div>
          <div class="small">by ${escapeHtml(r.authors||'')}</div>
          <div class="small">${r.series?`Series: ${escapeHtml(r.series.name)} #${r.series.number||'?'}`:'Standalone'} ${r.publishedDate?`• ${escapeHtml(r.publishedDate)}`:''}</div>
          <div class="chipline" style="margin-top:4px">${(r.recoTags||[]).slice(0,6).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
        </div>
        <button class="btn" onclick="pickResult(${i})">Pick</button>
      </div>
    `).join('');
    box.style.display='block';
  }catch(e){
    box.innerHTML = `<div class="small" style="padding:10px;color:#f88">Search error</div>`;
    box.style.display='block';
  }
}, 250);

$('#search').addEventListener('input', doLiveSearch);
document.addEventListener('click', (e)=>{
  if(!$('#results').contains(e.target) && e.target!==$('#search')){
    $('#results').style.display='none';
  }
});

/* ================== Pick & fill ================== */
window.pickResult = async function(i){
  const it = lastSearchItems[i]; if(!it) return;
  picked = it;
  // Fill UI
  $('#picked').style.display='grid';
  $('#picked-cover').src = it.image||'';
  $('#picked-cover').alt = `Cover of ${it.title}`;
  $('#picked-title').textContent = it.title;
  $('#picked-auth').textContent = `by ${it.authors||''}`;
  $('#picked-series').textContent = it.series ? `Series: ${it.series.name}${it.series.number?` #${it.series.number}`:''}` : 'Standalone';
  $('#picked-date').innerHTML = it.publishedDate ? `Published: ${escapeHtml(it.publishedDate)}` : '';
  $('#picked-cats').innerHTML = it.categories && it.categories.length ? `Categories: ${escapeHtml(it.categories.join(' / '))}` : '';
  $('#picked-desc').value = it.description || '';
  const recTags = it.recoTags || [];
  $('#reco-tags').innerHTML = recTags.length ? recTags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('') : '<span class="small">None detected</span>';
  $('#picked-tags').value = recTags.join(', ');
  $('#results').style.display = 'none';
  $('#picked-upcoming-note').textContent = '';

  // Upcoming detection for the picked one
  const d = toDateObj(it.publishedDate);
  const now = new Date();
  if(d && d > now){
    $('#picked-status').value = 'upcoming';
    $('#picked-release').value = d.toISOString().slice(0,10);
    $('#picked-upcoming-note').innerHTML = `<span class="warn">Upcoming:</span> release ${d.toISOString().slice(0,10)} stored.`;
  }else{
    $('#picked-release').value = '';
  }

  // SERIES LOOKUP (right after pick)
  await loadSeriesSuggestions(it);
};

async function loadSeriesSuggestions(primary){
  $('#series-list').innerHTML = '';
  $('#series-suggestions').style.display = 'none';
  $('#series-note').textContent = '';

  const mates = await findSeriesMatesByAuthorAndSeries(primary);
  pickedSeriesCandidates = mates;
  if(!mates.length){
    if(primary.series){
      $('#series-suggestions').style.display = 'block';
      $('#series-note').textContent = `No other volumes found for “${primary.series.name}” by this author (English results only).`;
    }
    return;
  }

  $('#series-suggestions').style.display = 'block';
  $('#series-note').textContent = `Found ${mates.length} matching volume${mates.length===1?'':'s'} in “${primary.series.name}”. Select any to add.`;

  const now = new Date();
  $('#series-list').innerHTML = mates.map((m, idx)=>{
    const rel = toDateObj(m.publishedDate);
    const upcoming = rel && rel > now;
    const recTags = recommendTagsFrom(m.title, m.description, m.categories||[]);
    return `
      <div class="result">
        <input type="checkbox" class="series-ck" data-idx="${idx}" style="margin-top:6px" ${ (m.series?.number && primary.series?.number && (m.series.number===primary.series.number+1)) ? 'checked' : '' }>
        ${m.image?`<img src="${escapeHtml(m.image)}" class="cover" alt="">`:`<div class="cover"></div>`}
        <div class="grow">
          <div><strong>${escapeHtml(m.title)}</strong></div>
          <div class="small">by ${escapeHtml(m.authors||'')}</div>
          <div class="small">Series: ${escapeHtml(m.series?.name||primary.series?.name||'')} ${m.series?.number?`#${m.series.number}`:''} ${m.publishedDate?`• ${escapeHtml(m.publishedDate)}`:''} ${upcoming?` • <span class="warn">Upcoming</span>`:''}</div>
          <div class="chipline" style="margin-top:4px">${recTags.slice(0,6).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
          <div class="small">Add as:
            <select class="select inline series-as" data-idx="${idx}" style="width:auto">
              <option value="wish">Want to Read</option>
              <option value="reading">Currently Reading</option>
              <option value="read">Read</option>
              <option value="upcoming" ${upcoming?'selected':''}>Upcoming</option>
            </select>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/* ================== Add picked & series ================== */
function buildTagsFromInput(){
  return ($('#picked-tags').value||'')
    .split(',')
    .map(t=>normalizeTag(t))
    .filter(Boolean)
    .slice(0,12);
}
function mapToLibraryEntry(src, statusOverride, tagsOverride){
  const now = new Date();
  const rel = toDateObj(src.publishedDate);
  const upcoming = rel && rel > now;
  const status = statusOverride || (upcoming ? 'upcoming' : 'wish');
  return {
    id: src.id,
    title: src.title,
    author: src.authors||'',
    image: src.image||'',
    synopsis: src.description||'',
    tags: tagsOverride && tagsOverride.length ? tagsOverride : (src.recoTags||[]),
    status,
    releaseDate: status==='upcoming' ? (rel? rel.toISOString().slice(0,10):'') : ($('#picked-release').value||''),
    publishedDate: src.publishedDate||'',
    series: src.series || null,
    genre: (src.categories&&src.categories[0]) || ''
  };
}

$('#regen-tags').addEventListener('click', ()=>{
  if(!picked) return;
  const rec = recommendTagsFrom(picked.title, $('#picked-desc').value, picked.categories||[]);
  $('#reco-tags').innerHTML = rec.length ? rec.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('') : '<span class="small">None detected</span>';
  $('#picked-tags').value = rec.join(', ');
});

$('#add-picked').addEventListener('click', ()=>{
  if(!picked) return;
  const status = $('#picked-status').value;
  const tagList = buildTagsFromInput();
  const entry = mapToLibraryEntry(picked, status, tagList);
  // If date typed & future -> force upcoming
  const typedDate = $('#picked-release').value.trim();
  if(typedDate){
    const d = toDateObj(typedDate);
    if(d && d > new Date()){
      entry.status = 'upcoming';
      entry.releaseDate = d.toISOString().slice(0,10);
    }
  }
  library.unshift(entry);
  renderLibrary();
});

$('#clear-picked').addEventListener('click', ()=>{
  picked = null; pickedSeriesCandidates = [];
  $('#picked').style.display='none';
  $('#series-suggestions').style.display='none';
});

$('#add-selected-series').addEventListener('click', ()=>{
  if(!pickedSeriesCandidates.length) return;
  const chosen = [];
  $$('.series-ck').forEach(ck=>{
    if(ck.checked){
      const idx = Number(ck.getAttribute('data-idx'));
      const src = pickedSeriesCandidates[idx];
      if(!src) return;
      const asSel = $(`.series-as[data-idx="${idx}"]`);
      const status = asSel ? asSel.value : 'wish';
      // compute tags
      const tags = recommendTagsFrom(src.title, src.description, src.categories||[]);
      // build entry & handle upcoming
      const entry = mapToLibraryEntry(src, status, tags);
      if(status==='upcoming' || (toDateObj(src.publishedDate) && toDateObj(src.publishedDate) > new Date())){
        entry.status='upcoming';
        entry.releaseDate = toDateObj(src.publishedDate)?.toISOString().slice(0,10) || '';
      }
      chosen.push(entry);
    }
  });
  if(!chosen.length) return;
  library = chosen.concat(library);
  renderLibrary();
});

/* ================== Filters / Export ================== */
$('#filter-all').onclick=()=>{ filter='all'; renderLibrary(); };
$('#filter-wish').onclick=()=>{ filter='wish'; renderLibrary(); };
$('#filter-reading').onclick=()=>{ filter='reading'; renderLibrary(); };
$('#filter-read').onclick=()=>{ filter='read'; renderLibrary(); };
$('#filter-upcoming').onclick=()=>{ filter='upcoming'; renderLibrary(); };
$('#export-json').onclick=()=>{
  const blob=new Blob([JSON.stringify(library,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='plotline-library.json'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
};

/* ================== Init ================== */
renderLibrary();
</script>
</body>
</html>
