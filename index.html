<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>PlotLine</title>

<!-- iOS meta/icons -->
<meta name="theme-color" content="#2f4a3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="PlotLine">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link id="app-manifest" rel="manifest">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAADYCAQAAAAzSx0mAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE="/>

<style>
  :root{
    --paper:#f4f1ea; --paper-2:#fbfaf7; --ink:#382110; --ink-2:#333;
    --accent:#00635d; --gold:#f4c150; --line:#d6d0c4; --muted:#6a5d50;
    --shadow:0 2px 6px rgba(0,0,0,.06);
    --s-top: env(safe-area-inset-top, 0px);
    --s-right: env(safe-area-inset-right, 0px);
    --s-bottom: env(safe-area-inset-bottom, 0px);
    --s-left: env(safe-area-inset-left, 0px);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%}
  body{
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; -webkit-tap-highlight-color: transparent;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    background:var(--paper);color:var(--ink);
    min-height:100dvh;
    padding:14px;
    padding-top:calc(14px + var(--s-top));
    padding-bottom:calc(14px + var(--s-bottom));
    padding-left:calc(14px + var(--s-left));
    padding-right:calc(14px + var(--s-right));
  }
  .container{max-width:980px;margin:0 auto}
  .header{color:var(--ink);text-align:center;margin-bottom:14px}
  .header h1{font-size:1.8rem;margin-bottom:4px;font-family:Georgia,'Times New Roman',serif;font-weight:700}
  .header p{opacity:.9;font-size:.95rem}

  .stats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .stat{background:#fff;padding:10px 12px;border-radius:10px;border:1px solid var(--line);box-shadow:var(--shadow);font-size:12px;display:flex;align-items:center;gap:8px}
  .stat strong{font-size:18px;line-height:1}

  .content{background:#fff;border-radius:12px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--line)}

  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .nav-btn{background:transparent;color:var(--accent);border:none;padding:8px 10px;border-bottom:2px solid transparent;border-radius:0;font-size:13px;font-weight:800;cursor:pointer}
  .nav-btn:hover{color:#004f49}
  .nav-btn.active{border-color:var(--accent)}

  .search{display:grid;grid-template-columns:2fr 1fr repeat(3,1fr);gap:8px;margin:8px 0}
  .input,.select,.textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:6px;font-size:16px;background:#fff}
  .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,99,93,.08)}

  .chip{background:#ede6d6;border:1px solid #e1d7c6;color:#5a4632;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}

  .feed{display:flex;flex-direction:column;gap:12px}
  .post{border:1px solid var(--line);border-left:4px solid #ddd;border-radius:8px;padding:12px;background:#fff;box-shadow:var(--shadow)}
  .group-title{font-size:.95rem;font-weight:900;color:#2a3a33;margin:4px 0 2px}
  .head{display:flex;gap:12px;align-items:flex-start}
  .cover{width:64px;height:96px;object-fit:cover;border-radius:4px;border:1px solid #e6ece8;flex-shrink:0}
  .cover-ph{width:64px;height:96px;background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#2d3436;flex-shrink:0}
  .info{flex:1}
  .genre{background:#ede6d6;color:#5a4632;border:1px solid #e1d7c6;padding:1px 8px;border-radius:12px;font-size:11px;font-weight:800;display:inline-block;margin-bottom:6px}
  .series{background:#eef4ef;border:1px solid #b9c9bf;color:#1b2a23;padding:1px 8px;border-radius:12px;font-size:11px;font-weight:800;display:inline-block;margin:0 6px 6px 0}
  .title{font-size:1.08rem;font-weight:900;color:var(--ink);line-height:1.2;font-family:Georgia,'Times New Roman',serif}
  .author{color:#6a5d50;font-style:italic;margin:2px 0 4px;font-size:13px}
  .rating-line{display:flex;align-items:center;gap:8px;font-size:12px;margin:2px 0 6px;color:#6a5d50}
  .tags{display:flex;flex-wrap:wrap;gap:4px}
  .tag{background:#eef4ef;border:1px solid #b9c9bf;color:#1b2a23;padding:1px 6px;border-radius:999px;font-size:11px;font-weight:700}
  .status-note{font-size:12px;color:#5a4632;margin-top:4px}

  .actions{display:flex;gap:8px;align-items:center;padding:8px 0;border-top:1px solid #ece6d8;margin:8px 0 6px;flex-wrap:wrap}
  .action{background:#f6f2e8;color:#5a4632;border:1px solid var(--line);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:800}
  .action:hover,.action.active{background:#e9e1cf;color:#2f271e}

  .syn{color:#2a3a33;line-height:1.4;font-size:14px}

  .toast{position:fixed;bottom:18px;right:18px;background:#3a3a3a;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;pointer-events:none;z-index:9999;max-width:70ch;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.error{background:#a64a4a}

  .results-bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px;gap:8px;flex-wrap:nowrap}
  .results-right{display:flex;gap:6px;align-items:center;white-space:nowrap}

  .stars{position:relative;display:inline-block;font-size:18px;line-height:1}
  .stars .bg{color:#ddd}
  .stars .fg{position:absolute;left:0;top:0;white-space:nowrap;color:var(--gold);pointer-events:none;overflow:hidden}
  .star-hit{position:absolute;top:0;left:0;width:100%;height:100%;display:grid;grid-template-columns:repeat(10,1fr)}
  .star-hit button{background:transparent;border:0;padding:0;margin:0;cursor:pointer}

  #finish-modal,#search-modal{position:fixed;left:50%;top:8%;transform:translate(-50%,0);background:#2f2f2f;color:#fff;border-radius:10px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:10000;display:none;max-width:720px;width:96%}
  #finish-modal.show,#search-modal.show{display:block}
  #search-modal h3{margin-bottom:8px}
  #search-results{max-height:52vh;overflow:auto;background:#fff;color:#2a2a2a;border-radius:8px;border:1px solid #ddd;padding:8px}
  .result-row{display:flex;gap:8px;align-items:flex-start;border-bottom:1px solid #eee;padding:6px 0}
  .result-row:last-child{border-bottom:0}

  @media(max-width:840px){ .search{grid-template-columns:1fr 1fr 1fr} }
  @media(max-width:640px){
    .search{grid-template-columns:1fr}
    .results-bar{flex-wrap:wrap;gap:6px}
    .results-right{width:100%;justify-content:space-between}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>PlotLine</h1>
      <p>Your private reading feed</p>
    </div>

    <!-- Stats row, always visible -->
    <div class="stats" id="stats">
      <div class="stat"><strong id="total-books">0</strong> books</div>
      <div class="stat" title="Finished"><strong id="books-read">0</strong> read</div>
      <div class="stat"><strong id="read-month">0</strong> this month</div>
      <div class="stat"><strong id="read-year">0</strong> this year</div>
      <div class="stat"><strong id="avg-rating">0.0</strong> avg ‚òÖ</div>
    </div>

    <main class="content">
      <nav class="nav" id="main-nav">
        <button class="nav-btn active" id="feed-btn" type="button">Library</button>
        <button class="nav-btn" id="prefs-btn" type="button">Goals & Backup</button>
      </nav>

      <!-- LIBRARY (only main view) -->
      <section id="feed" class="section active">
        <div class="search">
          <input type="text" class="input" placeholder="Search your library (title, author, tag) ‚Äî if no match, we‚Äôll fetch & detect the series‚Ä¶" id="search-input"/>
          <select class="select" id="tag-filter"><option value="">All Tags</option></select>
          <select class="select" id="category-filter"><option value="">All Categories</option></select>
          <select class="select" id="min-rating"><option value="0">Min ‚òÖ (Any)</option><option value="5">5‚òÖ</option><option value="4">4‚òÖ+</option><option value="3">3‚òÖ+</option></select>
          <select class="select" id="sort-by"><option value="smart">Smart (Reading first)</option><option value="new">Newest</option><option value="rating">Highest Rated</option><option value="title">Title A‚ÄìZ</option></select>
        </div>

        <div class="results-bar">
          <span class="chip" id="result-count"></span>
          <div class="results-right">
            <label class="chip"><input type="checkbox" id="collapse-all"> Collapse synopses</label>
            <button class="action" id="check-releases-btn" type="button">Check Releases</button>
          </div>
        </div>

        <!-- Grouped library feed -->
        <div id="books-feed" class="feed"></div>
      </section>

      <!-- PREFS -->
      <section id="prefs" class="section">
        <h2 style="margin-bottom:8px;color:var(--ink);font-size:1.1rem">Goals & Backup</h2>

        <div class="post" style="margin-bottom:10px">
          <h3>Reading Goals</h3>
          <div class="search" style="grid-template-columns:repeat(4,1fr)">
            <div><label class="chip">Year</label><input id="goal-year" class="input" type="number"/></div>
            <div><label class="chip">Total Books</label><input id="goal-total" class="input" type="number"/></div>
            <div><label class="chip">Catholic</label><input id="goal-catholic" class="input" type="number"/></div>
            <div><label class="chip">Fiction</label><input id="goal-fiction" class="input" type="number"/></div>
          </div>
          <div class="search" style="grid-template-columns:repeat(3,1fr)">
            <div><label class="chip">Nonfiction</label><input id="goal-nonfiction" class="input" type="number"/></div>
            <div></div><div></div>
          </div>
          <button id="save-goals" class="action" type="button">Save Goals</button>
        </div>

        <div class="post" style="margin-bottom:10px">
          <h3>Export / Backup</h3>
          <p class="chip" style="display:inline-block;margin-bottom:6px">Downloads CSV + JSON. (Cloud sync optional)</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="export-csv-btn" class="action" type="button">Download CSVs</button>
            <button id="export-json-btn" class="action" type="button">Download JSON</button>
            <label class="action" style="cursor:pointer">Import JSON<input type="file" id="import-json" accept="application/json" style="display:none"></label>
          </div>
        </div>

        <div class="post">
          <h3>Cloud Sync (JSONBin)</h3>
          <p class="chip" id="sync-status">Idle</p>
          <div class="search" style="grid-template-columns:2fr 2fr auto auto">
            <input id="cloud-api" class="input" placeholder="Paste your JSONBin API key"/>
            <input id="cloud-bin" class="input" placeholder="Paste your Bin ID"/>
            <button id="cloud-save" class="action" type="button">Save</button>
            <button id="cloud-create" class="action" type="button">Create New Bin</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="cloud-pull" class="action" type="button">Pull</button>
            <button id="cloud-push" class="action" type="button">Push</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Finish & Rate -->
  <div id="finish-modal">
    <div>
      <h3 id="finish-heading" style="margin-bottom:6px">Rate this book</h3>
      <p id="finish-title" class="chip" style="margin-bottom:6px"></p>
      <div class="stars" id="finish-stars" style="margin:6px 0 4px">
        <div class="bg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="fg" id="finish-fg" style="width:0%">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="star-hit" id="finish-hit"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="action" id="finish-save" type="button">Save</button>
        <button class="action" id="finish-cancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Search & Add (auto-opens when no local matches) -->
  <div id="search-modal">
    <div>
      <h3>Not in your library ‚Äî search & add</h3>
      <div class="search" style="grid-template-columns:2fr 1fr auto">
        <input id="ext-search-input" class="input" placeholder="Title or series name"/>
        <input id="ext-search-author" class="input" placeholder="Author (optional)"/>
        <button id="ext-search-btn" class="action" type="button">Search</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0">
        <button id="ext-select-all" class="action" type="button">Select All</button>
        <button id="ext-add-selected" class="action" type="button">Add Selected to Want to Read</button>
        <label class="chip"><input type="checkbox" id="ext-watch"> Watch this series</label>
        <button id="ext-check-releases" class="action" type="button">Check Releases</button>
      </div>
      <div id="search-results"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="action" id="ext-close" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
/* ===== Kill old service workers ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
}

/* ===== Helpers ===== */
function rAll(str, search, replacement){ return String(str).split(search).join(replacement); }
function escapeHtml(s){ s=String(s==null?'':s); s=rAll(s,'&','&amp;'); s=rAll(s,'<','&lt;'); s=rAll(s,'>','&gt;'); return s; }
function escapeAttr(s){ return rAll(escapeHtml(s),'"','&quot;'); }
function nowISO(){ return new Date().toISOString(); }
function formatDate(v){ var n=Number(v); var d=new Date(isFinite(n)?n:v); try{ return d.toLocaleDateString(); }catch(_e){ return d.toISOString().slice(0,10);} }
function showToast(msg,isError){ var t=document.getElementById('toast'); t.textContent=msg; t.classList.toggle('error',!!isError); t.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(function(){ t.classList.remove('show'); }, isError?4200:2000); }
function truncate(s,n){ s=String(s||''); n=n||300; return s.length>n? s.slice(0,n-1)+'‚Ä¶' : s; }
function toDateObj(publishedDate){
  if(!publishedDate) return null;
  var parts = String(publishedDate).split('-').map(Number);
  var y=parts[0], m=(parts[1]||1)-1, d=(parts[2]||1);
  var dt=new Date(Date.UTC(y,m,d));
  return isNaN(dt.getTime())? null : dt;
}
function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

/* ===== Storage / Cloud (JSONBin v3) ===== */
const DEFAULT_JSONBIN_API = 'https://api.jsonbin.io/v3';
const DEFAULT_BIN_ID = '68b3cb8dd0ea881f406ca19e'; 
const DEFAULT_API_KEY = '$2a$10$1k.Aw1WU5YTjSlKmSLGQ3eK6gaEhRB/j.FzTEtMp7Ardqd7vI4i4C'; 

function getApiKey(){ return (localStorage.getItem('plotline_api_key') || DEFAULT_API_KEY).trim(); }
function getBinId(){ return (localStorage.getItem('plotline_bin_id') || DEFAULT_BIN_ID).trim(); }
function getApiBase(){ return (localStorage.getItem('plotline_api_base') || DEFAULT_JSONBIN_API).trim(); }

let books = [];
let sitePrefs = { goals: { year: new Date().getFullYear(), total: 0, byTag: { catholic:0, fiction:0, nonfiction:0 } }, watchSeries: {} };

function jbHeaders(){ return { 'Content-Type':'application/json','X-Master-Key': getApiKey(),'X-Bin-Meta': 'false','Accept':'application/json' }; }
function ns(record){ return (record && record.plotline) ? record.plotline : record; }

async function loadAll(){
  try{
    var cached = JSON.parse(localStorage.getItem('plotline_payload')||'{}');
    if(cached.books) books = cached.books;
    if(cached.sitePrefs) sitePrefs = Object.assign({watchSeries:{}}, cached.sitePrefs);
  }catch(_e){}
  try{
    const r = await fetch(`${getApiBase()}/b/${getBinId()}/latest`,{headers: jbHeaders()});
    if(r.ok){
      const data = await r.json();
      const record = (data && (data.record ?? data)) || {};
      const scoped = ns(record);
      if (Array.isArray(scoped)) { books = scoped; }
      else {
        books = Array.isArray(scoped?.books) ? scoped.books
              : (Array.isArray(record) ? record : (record.books || books));
        sitePrefs = Object.assign({watchSeries:{}}, scoped?.sitePrefs || record.sitePrefs || sitePrefs);
      }
      try{ localStorage.setItem('plotline_payload', JSON.stringify({books,sitePrefs})); }catch(_e){}
      var s=document.getElementById('sync-status'); if(s) s.textContent='Pulled';
    }
  }catch(e){ console.warn('Cloud pull failed; using local', e); }
}
async function saveAll(){
  try{ localStorage.setItem('plotline_payload', JSON.stringify({books,sitePrefs})); }catch(_e){}
  try{
    const latest = await fetch(`${getApiBase()}/b/${getBinId()}/latest`, { headers: jbHeaders() });
    let record = latest.ok ? ((await latest.json()).record || {}) : {};
    record.plotline = { books, sitePrefs };
    const r = await fetch(`${getApiBase()}/b/${getBinId()}`,{ method:'PUT', headers: jbHeaders(), body: JSON.stringify(record) });
    if(!r.ok){ const txt = await r.text(); throw new Error(`Push ${r.status}: ${txt.slice(0,140)}`); }
    var s=document.getElementById('sync-status'); if(s) s.textContent='Pushed';
  }catch(e){ console.warn('Remote save failed',e); var s2=document.getElementById('sync-status'); if(s2) s2.textContent='Push failed'; }
}
async function cloudPull(){ document.getElementById('sync-status').textContent='Pulling‚Ä¶'; await loadAll(); applyFilters(); updateStats(); document.getElementById('sync-status').textContent='Pulled'; showToast('Cloud pulled'); }
async function cloudPush(){ try{ document.getElementById('sync-status').textContent='Pushing‚Ä¶'; await saveAll(); document.getElementById('sync-status').textContent='Pushed'; showToast('Cloud pushed'); }catch(e){ document.getElementById('sync-status').textContent='Push failed'; showToast(e.message||'Push failed',true);} }
async function cloudCreate(){
  try{
    document.getElementById('sync-status').textContent = 'Creating‚Ä¶';
    const initial = { plotline: { books, sitePrefs } };
    const r=await fetch(`${getApiBase()}/b`,{method:'POST',headers: jbHeaders(),body:JSON.stringify(initial)});
    if(!r.ok){ const txt = await r.text(); throw new Error(`Create ${r.status}: ${txt.slice(0,140)}`); }
    const data=await r.json();
    const newId=(data.metadata && data.metadata.id)||data.id;
    if(!newId) throw new Error('No Bin ID returned');
    localStorage.setItem('plotline_bin_id', newId);
    document.getElementById('cloud-bin').value = newId;
    showToast('New JSONBin created & saved: '+newId);
    document.getElementById('sync-status').textContent='New bin created';
  }catch(e){ console.warn(e); document.getElementById('sync-status').textContent='Create failed'; showToast(e.message||'Create failed',true); }
}

/* ===== Data Model Helpers ===== */
function newBook(obj){
  const id=Date.now()+Math.floor(Math.random()*1000);
  const b={
    id,
    title: (obj.title||'').trim(),
    author:(obj.author||'').trim(),
    image: (obj.image||'').trim(),
    synopsis: (obj.synopsis||'').trim(),
    genre: (obj.genre||'other').toLowerCase(),
    tags: Array.isArray(obj.tags)? obj.tags.slice(0,12).map(t=>String(t).toLowerCase().trim()).filter(Boolean) : [],
    addedAt: nowISO(),
    status: obj.status||'wish',
    releaseDate: obj.releaseDate||'',
    series: obj.series||null,   // {name,number}
    sessions: [],
    rating: Number(obj.rating||0)||0
  };
  if(b.status==='wish') b.wantAt=nowISO();
  if(b.status==='upcoming') { b.wantAt=b.wantAt||nowISO(); }
  if(b.status==='reading') { b.wantAt=b.wantAt||nowISO(); startReading(b); }
  if(b.status==='read') { b.wantAt=b.wantAt||nowISO(); startReading(b); finishReading(b, obj.rating||0); }
  return b;
}
function startReading(b){
  if(!b.sessions) b.sessions=[];
  const open=b.sessions.find(s=>!s.finishedAt);
  if(open) return;
  b.sessions.push({startedAt: nowISO()});
  b.status='reading'; b.startAt = b.sessions[b.sessions.length-1].startedAt;
}
function finishReading(b, rating){
  if(!b.sessions || !b.sessions.length) startReading(b);
  const cur=b.sessions[b.sessions.length-1];
  if(!cur.finishedAt) cur.finishedAt=nowISO();
  if(isFinite(rating) && rating>0){ cur.rating = rating; b.rating = rating; }
  b.status='read'; b.finishAt = cur.finishedAt;
}
function setWish(b){ b.status='wish'; b.wantAt = b.wantAt || nowISO(); }
function goodreadsUrl(book){ var q=((book.title||'')+' '+(book.author||'')).trim(); return 'https://www.goodreads.com/search?q='+encodeURIComponent(q)+'&search_type=books'; }

/* ===== Rendering ===== */
function starWidthFromRating(r){ r = Math.max(0, Math.min(5, Number(r)||0)); return (r/5*100).toFixed(0)+'%'; }
function starWidgetHTML(widthPct){ return '<div class="stars"><div class="bg">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="fg" style="width:'+escapeAttr(widthPct)+'">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div></div>'; }
function youStatusLine(b){
  if(b.status==='upcoming'){
    const rd = b.releaseDate? formatDate(b.releaseDate) : 'TBA';
    return `<div class="status-note"><strong>Upcoming</strong> ‚Äî releases ${rd}</div>`;
  }
  if(b.status==='read'){
    const r=b.rating?` ‚Äî ${Number(b.rating).toFixed(1)}‚òÖ`:''; return `<div class="status-note"><strong>You</strong> finished on ${formatDate(b.finishAt)}${r}</div>`;
  }
  if(b.status==='reading') return `<div class="status-note"><strong>You</strong> started on ${formatDate(b.startAt)}</div>`;
  if(b.status==='wish') return `<div class="status-note"><strong>You</strong> want to read (added ${formatDate(b.wantAt)})</div>`;
  return '';
}
function seriesChip(b){
  if(!b.series || !b.series.name) return '';
  let n = (b.series.number!=null && b.series.number!=='')? ` #${b.series.number}` : '';
  return `<span class="series" title="Series">${escapeHtml(b.series.name)}${n}</span>`;
}
function synBlock(book){
  if(!book.synopsis) return '';
  const long = book.synopsis.length>280; const short = truncate(book.synopsis,280);
  return [
    '<div class="syn" data-syn="'+book.id+'">',
    '  <span class="syn-text" data-expanded="false">'+escapeHtml(short)+'</span>',
    long?(' <button class="action" type="button" data-action="toggle-synopsis" data-id="'+book.id+'">Read more</button>'):'',
    '</div>'
  ].join('');
}
function tagChips(tags){
  if(!tags || !tags.length) return '';
  return '<div class="tags">' + tags.map(function(t){ return '<span class="tag">'+escapeHtml(t)+'</span>'; }).join('') + '</div>';
}
function bookCoverBlock(book){
  var link=goodreadsUrl(book);
  if(book.image){
    return '<a href="'+link+'" target="_blank" rel="noopener noreferrer"><img class="cover" loading="lazy" alt="Cover of '+escapeHtml(book.title)+'" src="'+escapeAttr(book.image)+'"/></a>';
  }
  return '<a href="'+link+'" target="_blank" rel="noopener noreferrer" class="cover-ph">No Cover</a>';
}
function nextInSeriesOffline(b){
  if(!b.series || !b.series.name || !isFinite(Number(b.series.number))) return null;
  const target = Number(b.series.number)+1;
  const found = books.find(x=>x.series && x.series.name.toLowerCase()===b.series.name.toLowerCase() && Number(x.series.number)===target);
  return found || { placeholder:true, name:b.series.name, number:target };
}
function smsHrefForBook(b){
  const body = encodeURIComponent(`${b.title} ‚Äî ${b.author}${b.series&&b.series.name?` (${b.series.name}${b.series.number?` #${b.series.number}`:''})`:''}${b.rating?` ‚Ä¢ ${b.rating.toFixed(1)}‚òÖ`:''}`);
  return isiOS()? `sms:&body=${body}` : `sms:?body=${body}`;
}
function bookCard(book){
  const width=starWidthFromRating(book.rating||0);
  const collapsed = (document.getElementById('collapse-all') && document.getElementById('collapse-all').checked);
  const next = nextInSeriesOffline(book);
  let nextBlock='';
  if(next){
    if(next.placeholder){
      nextBlock = `<div class="status-note">Next in series: <strong>#${next.number}</strong> ‚Äî <button class="action" type="button" data-action="find-next" data-id="${book.id}">Find & add</button></div>`;
    }else{
      nextBlock = `<div class="status-note">Next in series available: <strong>${escapeHtml(next.title)}</strong> ‚Äî <button class="action" type="button" data-action="wish" data-id="${next.id}">Add to Wish</button></div>`;
    }
  }
  return [
    '<article class="post" id="book-'+book.id+'" data-id="'+book.id+'">',
    '  <div class="head">',
    '    '+bookCoverBlock(book),
    '    <div class="info">',
    '      <div><span class="genre">'+escapeHtml(book.genre||'other')+'</span> '+seriesChip(book)+'</div>',
    '      <div class="title">'+escapeHtml(book.title)+'</div>',
    '      <div class="author">by '+escapeHtml(book.author)+'</div>',
    '      <div class="rating-line">'+starWidgetHTML(width)+'<span class="chip">'+(book.rating? (Number(book.rating).toFixed(1)+'‚òÖ') : 'No rating')+'</span></div>',
    tagChips(book.tags),
    youStatusLine(book),
    nextBlock,
    '    </div>',
    '  </div>',
    collapsed? '' : synBlock(book),
    '  <div class="actions">',
    '    <button class="action" type="button" data-action="wish" data-id="'+book.id+'">üìö Want to Read</button>',
    '    <button class="action" type="button" data-action="reading" data-id="'+book.id+'">üìñ Start / Currently Reading</button>',
    '    <button class="action" type="button" data-action="finish" data-id="'+book.id+'">‚úÖ Finish & Rate</button>',
    '    <button class="action" type="button" data-action="find-like" data-id="'+book.id+'">üîé More like this</button>',
    '    <a class="action" href="'+smsHrefForBook(book)+'" data-action="sms" data-id="'+book.id+'">üì≤ Text</a>',
    '    <button class="action" type="button" data-action="edit" data-id="'+book.id+'">‚úèÔ∏è Edit</button>',
    '    <button class="action" type="button" data-action="delete" data-id="'+book.id+'">üóëÔ∏è Delete</button>',
    '  </div>',
    '</article>'
  ].join('');
}

/* Grouped render: Reading ‚Üí Upcoming ‚Üí Wish ‚Üí Read (smart sort) */
let currentBooks=[];
function groupedByStatus(list){
  const g = {reading:[],upcoming:[],wish:[],read:[]};
  list.forEach(b=>{ (g[b.status]||g.read).push(b); });
  return g;
}
function renderBooks(){
  const c=document.getElementById('books-feed');
  if(!currentBooks.length){
    c.innerHTML='<div style="text-align:center;padding:28px;color:#6a5d50"><h3 style="font-size:1rem">No books found</h3><p class="chip">Type in the search box to add new titles (auto series).</p></div>';
    document.getElementById('result-count').textContent='0 results'; return;
  }
  const g = groupedByStatus(currentBooks);
  function sect(name, arr){ if(!arr.length) return ''; return `<div class="group-title">${name} (${arr.length})</div>` + arr.map(bookCard).join(''); }
  c.innerHTML=[
    sect('Currently Reading', g.reading),
    sect('Upcoming', g.upcoming),
    sect('Want to Read', g.wish),
    sect('Read', g.read)
  ].join('');
  document.getElementById('result-count').textContent=String(currentBooks.length)+' result'+(currentBooks.length===1?'':'s');
}

/* ===== Stats ===== */
function monthYearCounts(){
  const now=new Date(); const y=now.getFullYear(); const m=now.getMonth();
  let month=0, year=0; let sum=0, n=0;
  books.forEach(b=>{
    (b.sessions||[]).forEach(s=>{
      if(s.finishedAt){
        const d=new Date(s.finishedAt);
        if(d.getFullYear()===y){
          year++;
          if(d.getMonth()===m) month++;
          if(typeof s.rating==='number'){ sum+=s.rating; n++; }
        }
      }
    });
  });
  const totalRead=books.filter(b=>b.status==='read').length;
  const avg = n? (sum/n) : 0;
  document.getElementById('books-read').textContent=String(totalRead);
  document.getElementById('read-month').textContent=String(month);
  document.getElementById('read-year').textContent=String(year);
  document.getElementById('avg-rating').textContent=avg.toFixed(1);
  document.getElementById('total-books').textContent=String(books.length);
}
function updateStats(){ monthYearCounts(); }

/* ===== Filters / Search ===== */
function populateCategoryOptions(){
  var opts=[
    'Fiction','Non-Fiction','Biography','Memoir','Self-Help','Professional','Business',
    'Leadership','Entrepreneurship','Marketing','Finance','Personal Development',
    'History','Science','Technology','Psychology','Philosophy','Spirituality/Religion',
    'Health & Fitness','Cooking','Travel','Parenting','Education',
    'Mystery','Thriller','Horror','Romance','Fantasy','Sci-Fi','Dystopian','Young Adult',
    'Classics','Literary Fiction','Poetry','Comics/Graphic Novel','Reference','Other'
  ];
  document.getElementById('category-filter').innerHTML=['<option value="">All Categories</option>'].concat(opts.map(o=>'<option value="'+escapeAttr(o.toLowerCase())+'">'+escapeHtml(o)+'</option>')).join('');
}
function getAllTagsUnique(){
  var set={}; books.forEach(b=>{ (b.tags||[]).forEach(t=>{ set[String(t).toLowerCase()]=1; }); });
  return Object.keys(set).sort();
}
function populateTagFilter(){
  var sel=document.getElementById('tag-filter'); if(!sel) return;
  var cur=sel.value; var all=getAllTagsUnique();
  sel.innerHTML=['<option value="">All Tags</option>'].concat(all.map(t=>'<option value="'+escapeAttr(t)+'">'+escapeHtml(t)+'</option>')).join('');
  if(all.indexOf(cur)>-1) sel.value=cur;
}
function bookSearchScore(b,t){
  if(!t) return 1;
  var term=String(t).toLowerCase();
  function inStr(s){ return String(s||'').toLowerCase(); }
  var score=0; var title=inStr(b.title), author=inStr(b.author), syn=inStr(b.synopsis);
  var tags=(b.tags||[]).map(x=>String(x).toLowerCase());
  if(title===term) score+=100;
  if(title.indexOf(term)===0) score+=60;
  if(title.indexOf(term)>-1) score+=30;
  if(author.indexOf(term)===0) score+=30;
  if(author.indexOf(term)>-1) score+=20;
  if(syn.indexOf(term)>-1) score+=12;
  if(tags.some(x=>x.indexOf(term)>-1)) score+=25;
  return score;
}
function smartSort(list){
  return list.slice().sort((a,b)=>{
    const order = {reading:0, upcoming:1, wish:2, read:3};
    const sa = order[a.status] ?? 9, sb = order[b.status] ?? 9;
    if(sa!==sb) return sa-sb;
    if(a.status==='read') return (b.finishAt||0) > (a.finishAt||0) ? 1 : -1;
    return (b.id - a.id);
  });
}
function applyFilters(autoOpenModalIfEmpty=true){
  var term=document.getElementById('search-input').value.trim();
  var tagTerm=document.getElementById('tag-filter').value.trim().toLowerCase();
  var cat=document.getElementById('category-filter').value;
  var min=parseInt(document.getElementById('min-rating').value,10)||0;
  var sort=document.getElementById('sort-by').value;

  var list=books
    .map(function(b){ var o={}; for(var k in b) o[k]=b[k]; o._score=bookSearchScore(b,term); return o; })
    .filter(function(b){ if(term && b._score<=0) return false; if(cat && b.genre!==cat) return false; if(min && (Number(b.rating)||0) < min) return false; if(tagTerm && (b.tags||[]).map(t=>String(t).toLowerCase()).indexOf(tagTerm)===-1) return false; return true; });

  if(term){ list.sort((a,b)=> (b._score-a._score) || (b.id-a.id)); }
  else if(sort==='smart'){ list = smartSort(list); }
  else if(sort==='new'){ list.sort((a,b)=> b.id-a.id); }
  else if(sort==='rating'){ list.sort((a,b)=> (Number(b.rating)||0)-(Number(a.rating)||0)); }
  else if(sort==='title'){ list.sort((a,b)=> a.title.localeCompare(b.title)); }

  currentBooks=list; renderBooks();

  // If user typed something and there are no local matches => auto open external search modal
  if(autoOpenModalIfEmpty && term && term.length>=3 && currentBooks.length===0){
    openSearchModal(term,'');
    runExternalSearch(term,'');
  }
}

/* ===== Google Books Search + Series Finder ===== */
let lastSearchItems=[];
const GBOOKS = 'https://www.googleapis.com/books/v1/volumes';
function normalizeAuthors(a){ return (Array.isArray(a)? a : (a? [a] : [])).join(', '); }
function parseSeriesFromTitle(title){
  if(!title) return null;
  const t=String(title);
  let m = t.match(/\(([^()]+?),\s*#\s*([\d.]+)\)\s*$/i);
  if(m) return { name: m[1].trim(), number: m[2].trim() };
  m = t.match(/Book\s*([\d.]+)\s*(?:of|in)\s*([A-Za-z0-9'‚Äô\-: ]+)/i);
  if(m) return { name: m[2].trim(), number: m[1].trim() };
  m = t.match(/#\s*([\d.]+)\s*\(([^()]+?)\)\s*$/i);
  if(m) return { name: m[2].trim(), number: m[1].trim() };
  return null;
}
async function googleBooksSearch(q, maxResults){
  const url = `${GBOOKS}?q=${encodeURIComponent(q)}&maxResults=${Math.min(40, maxResults||20)}`;
  const r = await fetch(url); if(!r.ok) throw new Error('Search failed '+r.status);
  return await r.json();
}
function volumeToItem(it){
  const v=it.volumeInfo||{};
  const title=v.title||'Unknown Title';
  const authors=normalizeAuthors(v.authors||[]);
  const cover=(v.imageLinks&& (v.imageLinks.thumbnail||v.imageLinks.smallThumbnail))||'';
  const description=v.description||'';
  const categories=v.categories||[];
  const publishedDate=v.publishedDate||'';
  const seriesGuess = parseSeriesFromTitle(title);
  const seriesNumberGuess = (seriesGuess && seriesGuess.number) ? Number(seriesGuess.number) : null;
  return { id: it.id, title, authors, cover, description, categories, publishedDate, seriesGuess, seriesNumberGuess };
}
function mapCategoriesToGenre(cats){
  const c = (cats||[]).join(' | ').toLowerCase();
  const picks = [
    ['mystery','mystery'],['thriller','thriller'],['horror','horror'],['romance','romance'],
    ['science fiction','sci-fi'],['sci-fi','sci-fi'],['fantasy','fantasy'],['young adult','young adult'],
    ['poetry','poetry'],['graphic novel','comics/graphic novel'],['comics','comics/graphic novel'],
    ['biography','biography'],['memoir','memoir'],['self-help','self-help'],['history','history'],
    ['technology','technology'],['business','business'],['finance','finance'],['psychology','psychology'],
    ['philosophy','philosophy'],['religion','spirituality/religion'],['spirituality','spirituality/religion'],
    ['cook','cooking'],['travel','travel'],['education','education'],['health','health & fitness'],
    ['fitness','health & fitness'],['literary','literary fiction'],['classics','classics'],
  ];
  for(const [needle, out] of picks){ if(c.includes(needle)) return out; }
  if(c.includes('fiction')) return 'fiction';
  if(c.includes('nonfiction') || c.includes('non-fiction')) return 'non-fiction';
  return 'other';
}
function categoriesToTags(cats){
  const raw = (cats||[])
    .map(x=>String(x).split(/[\/>|,&‚Äì-]/g))
    .flat()
    .map(x=>x.trim().toLowerCase())
    .filter(Boolean);
  return Array.from(new Set(raw)).slice(0,12);
}

/* ===== Search Modal (External search + series) ===== */
let seriesCtx = { name:'', author:'', items:[], selected:new Set() };
function openSearchModal(name, author){
  const m=document.getElementById('search-modal');
  document.getElementById('ext-search-input').value = name||'';
  document.getElementById('ext-search-author').value = author||'';
  document.getElementById('search-results').innerHTML='';
  document.getElementById('ext-watch').checked=false;
  m.classList.add('show');
}
function closeSearchModal(){ document.getElementById('search-modal').classList.remove('show'); }
function renderExternalResults(){
  const wrap=document.getElementById('search-results');
  if(!seriesCtx.items.length){ wrap.innerHTML='<div class="chip" style="padding:8px">No results</div>'; return; }
  wrap.innerHTML = seriesCtx.items.map((it,idx)=>{
    const checked = seriesCtx.selected.has(idx) ? 'checked' : '';
    const n = (it.seriesNumberGuess!=null) ? ` #${it.seriesNumberGuess}` : '';
    const rd = it.publishedDate ? ` ‚Ä¢ ${escapeHtml(it.publishedDate)}` : '';
    return `
      <div class="result-row" data-sidx="${idx}">
        <input type="checkbox" class="ext-check" data-sidx="${idx}" ${checked} style="width:18px;height:18px;margin:8px 6px 0 0">
        ${it.cover?`<img src="${escapeAttr(it.cover)}" style="width:36px;height:54px;border-radius:4px;border:1px solid #e6ece8;object-fit:cover;margin-right:8px">`:`<div style="width:36px;height:54px;border-radius:4px;background:#e9ecef;margin-right:8px"></div>`}
        <div style="flex:1 1 auto">
          <strong>${escapeHtml(it.title)}</strong>
          <div class="chip" style="margin-top:2px">${escapeHtml(it.authors||'')}</div>
          <div class="chip" style="margin-top:2px">${it.seriesGuess? 'Series: '+escapeHtml(it.seriesGuess.name)+n : 'Standalone?' }${rd}</div>
        </div>
        <button class="action" data-one-add="${idx}" type="button">Add</button>
      </div>
    `;
  }).join('');
}
async function runExternalSearch(name, author){
  seriesCtx.name = (name||'').trim();
  seriesCtx.author = (author||'').trim();
  let q = seriesCtx.name;
  if(seriesCtx.author) q += ` ${seriesCtx.author}`;
  if(!q){ renderExternalResults(); return; }
  try{
    const data = await googleBooksSearch(q, 40);
    const items = (data.items||[]).map(volumeToItem);

    // Auto-detect top series in results for the "watch" and releases buttons
    const names = items.map(x=>x.seriesGuess && x.seriesGuess.name).filter(Boolean);
    if(names.length){
      const counts = {}; names.forEach(n=>counts[n]=(counts[n]||0)+1);
      const top = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0];
      seriesCtx.name = top;
      document.getElementById('ext-search-input').value = top;
    }

    // Narrow to likely series entries first
    const filtered = items.filter(it=>{
      if(!it.title) return false;
      if(seriesCtx.name){
        const t = it.title.toLowerCase();
        return t.includes(seriesCtx.name.toLowerCase()) || !!it.seriesGuess;
      }
      return true;
    }).sort((a,b)=>{
      const an=a.seriesNumberGuess, bn=b.seriesNumberGuess;
      if(an!=null && bn!=null) return an-bn;
      if(an!=null) return -1;
      if(bn!=null) return 1;
      return a.title.localeCompare(b.title);
    });

    seriesCtx.items = filtered;
    seriesCtx.selected = new Set(filtered.map((_,i)=>i)); // preselect
    renderExternalResults();
  }catch(e){ console.warn(e); showToast('Search failed', true); }
}
function addSelectedExternalToWish(){
  const chosen = Array.from(seriesCtx.selected).map(i=>seriesCtx.items[i]);
  if(!chosen.length){ showToast('Select at least one book', true); return; }
  const now = new Date();
  const name = (seriesCtx.name||'').trim();
  const author = (seriesCtx.author||'').trim();
  chosen.forEach(it=>{
    const releaseDateObj = toDateObj(it.publishedDate);
    const isFuture = releaseDateObj && releaseDateObj.getTime() > now.getTime();
    const b=newBook({
      title: it.title,
      author: it.authors || author,
      image: it.cover||'',
      synopsis: it.description||'',
      genre: mapCategoriesToGenre(it.categories),
      tags: categoriesToTags(it.categories),
      status: isFuture? 'upcoming' : 'wish',
      releaseDate: isFuture? releaseDateObj.toISOString().slice(0,10): '',
      series: it.seriesGuess? { name: it.seriesGuess.name, number: (it.seriesNumberGuess!=null? String(it.seriesNumberGuess): '') } : (name? {name, number:''}: null),
      rating: 0
    });
    books.unshift(b);
  });
  saveAll(); populateTagFilter(); applyFilters(false); updateStats();
  showToast('Added '+chosen.length+' to Want to Read');
}

/* ===== Export / Import ===== */
function download(name, text, mime){ mime=mime||'text/csv;charset=utf-8;'; var blob=new Blob([text],{type:mime}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); }
function toCsvRow(arr){ function escCsvStr(s){ return String(s==null?'':s).replace(/"/g,'""'); } return arr.map(v=>'"'+escCsvStr(v)+'"').join(','); }
function exportCsvs(){
  var booksHeader = toCsvRow(['id','title','author','genre','image','rating','tags','synopsis','status','releaseDate','series.name','series.number','wantAt','startAt','finishAt']);
  var booksRows = books.map(function(b){return toCsvRow([b.id,b.title,b.author,b.genre,b.image||'',(b.rating||0).toFixed(1),(b.tags||[]).join('|'),(b.synopsis||''),b.status||'',b.releaseDate||'',(b.series&&b.series.name)||'',(b.series&&b.series.number)||'',b.wantAt||'',b.startAt||'',b.finishAt||'']);});
  download('books.csv',[booksHeader].concat(booksRows).join('\n'));
  download('plotline-export.json',JSON.stringify({books,sitePrefs},null,2),'application/json');
}
function exportJson(){ download('plotline-export.json',JSON.stringify({books,sitePrefs},null,2),'application/json'); }
function importJson(file){
  var fr=new FileReader();
  fr.onload=function(){
    try{
      var data=JSON.parse(fr.result);
      if(data.books) books=data.books;
      if(data.sitePrefs) sitePrefs=Object.assign({watchSeries:{}}, data.sitePrefs);
      saveAll(); populateTagFilter(); applyFilters(); updateStats();
      showToast('Import complete');
    }catch(e){ showToast('Invalid JSON',true); }
  };
  fr.readAsText(file);
}

/* ===== Modal / Rating (Finish & Rate) ===== */
let ratingDraft = 0; let finishContext=null;
function bindStarHit(elFg, elHit, feedbackEl){
  function setFromIndex(i){ const r = (i+1)/2; ratingDraft = r; elFg.style.width = starWidthFromRating(r); if(feedbackEl) feedbackEl.textContent = r.toFixed(1)+'‚òÖ'; }
  elHit.innerHTML = Array.from({length:10},(_,i)=>`<button type="button" data-i="${i}"></button>`).join('');
  elHit.addEventListener('click', function(e){ var btn=e.target.closest('button'); if(!btn) return; var i=Number(btn.getAttribute('data-i')); setFromIndex(i); });
}
function openFinishModal(book){
  finishContext = {bookId: book.id};
  document.getElementById('finish-title').textContent = book.title+' ‚Äî '+book.author;
  var fg=document.getElementById('finish-fg');
  var hit=document.getElementById('finish-hit');
  hit.innerHTML = ''; bindStarHit(fg,hit,null);
  ratingDraft = Number(book.rating||0);
  fg.style.width=starWidthFromRating(ratingDraft);
  document.getElementById('finish-modal').classList.add('show');
}
function closeFinishModal(){ document.getElementById('finish-modal').classList.remove('show'); finishContext=null; ratingDraft=0; }

/* ===== Watch / Releases ===== */
async function checkSeriesReleases(name, author){
  if(!name) return [];
  let q = `intitle:"${name}"`;
  if(author) q += ` inauthor:"${author}"`;
  try{
    const data = await googleBooksSearch(q, 40);
    const items=(data.items||[]).map(volumeToItem);
    const now=new Date();
    const upcoming = items
      .map(it=>{
        const dt=toDateObj(it.publishedDate);
        const g=parseSeriesFromTitle(it.title);
        const n=g && g.number? Number(g.number): null;
        return {title:it.title, authors:it.authors, date:dt, number:n};
      })
      .filter(x=>x.date && x.date.getTime()>now.getTime())
      .sort((a,b)=>a.date-b.date);
    return upcoming;
  }catch(e){ console.warn(e); return []; }
}
async function checkWatchedReleases(){
  const names = Object.keys(sitePrefs.watchSeries||{});
  if(!names.length) return;
  for(const name of names){
    const author = sitePrefs.watchSeries[name]||'';
    const releases = await checkSeriesReleases(name, author);
    if(releases.length){
      const first=releases[0];
      showToast(`Upcoming: ${escapeHtml(name)} #${first.number||'?'} ‚Äî ${escapeHtml(first.title)} on ${formatDate(first.date)}`);
    }
  }
}

/* ===== Boot / Events ===== */
document.addEventListener('DOMContentLoaded', function(){
  // Minimal manifest (no SW)
  try{
    const manifest={name:'PlotLine',short_name:'PlotLine',start_url:'./',display:'standalone',background_color:'#ffffff',theme_color:'#2f4a3e',icons:[{src:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAAAAABQFZ1hAAAAC0lEQVR42u3BAQ0AAADCoPdPbQ43oAAAAAB4p1nNAAE=',sizes:'192x192',type:'image/png'}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const url=URL.createObjectURL(blob);
    const link=document.getElementById('app-manifest'); if(link) link.href=url;
  }catch(_e){}

  loadAll().then(function(){
    populateCategoryOptions();
    populateTagFilter();
    applyFilters(false);
    updateStats();
    checkWatchedReleases();
  });

  // Nav
  document.getElementById('feed-btn').addEventListener('click', function(){ openSection('feed'); applyFilters(false); });
  document.getElementById('prefs-btn').addEventListener('click', function(){ openSection('prefs'); });

  // Filters
  document.getElementById('search-input').addEventListener('input', function(){ applyFilters(true); });
  document.getElementById('tag-filter').addEventListener('change', function(){ applyFilters(false); });
  document.getElementById('category-filter').addEventListener('change', function(){ applyFilters(false); });
  document.getElementById('min-rating').addEventListener('change', function(){ applyFilters(false); });
  document.getElementById('sort-by').addEventListener('change', function(){ applyFilters(false); });
  document.getElementById('collapse-all').addEventListener('change', renderBooks);

  // Check releases from feed
  document.getElementById('check-releases-btn').addEventListener('click', checkWatchedReleases);

  /* Search modal controls */
  document.getElementById('ext-search-btn').addEventListener('click', function(){
    runExternalSearch(document.getElementById('ext-search-input').value, document.getElementById('ext-search-author').value);
  });
  document.getElementById('ext-select-all').addEventListener('click', function(){
    seriesCtx.selected = new Set(seriesCtx.items.map((_,i)=>i)); renderExternalResults();
  });
  document.getElementById('ext-add-selected').addEventListener('click', addSelectedExternalToWish);
  document.getElementById('ext-close').addEventListener('click', closeSearchModal);
  document.getElementById('ext-check-releases').addEventListener('click', async function(){
    const name=document.getElementById('ext-search-input').value.trim();
    const author=document.getElementById('ext-search-author').value.trim();
    const up = await checkSeriesReleases(name, author);
    if(!up.length) { showToast('No upcoming releases detected'); return; }
    showToast(`Next release: ${escapeHtml(up[0].title)} on ${formatDate(up[0].date)}`);
  });
  document.getElementById('ext-watch').addEventListener('change', function(e){
    const name=document.getElementById('ext-search-input').value.trim();
    const author=document.getElementById('ext-search-author').value.trim();
    if(!name){ showToast('Enter a series name to watch', true); e.target.checked=false; return; }
    if(e.target.checked){ sitePrefs.watchSeries[name]=author||''; showToast('Watching "'+name+'"'); }
    else { delete sitePrefs.watchSeries[name]; showToast('Stopped watching "'+name+'"'); }
    saveAll();
  });
  document.getElementById('search-results').addEventListener('click', function(e){
    const cb = e.target.closest('.ext-check');
    if(cb){ const i=Number(cb.getAttribute('data-sidx')); if(cb.checked) seriesCtx.selected.add(i); else seriesCtx.selected.delete(i); return; }
    const btn = e.target.closest('[data-one-add]');
    if(btn){
      const i=Number(btn.getAttribute('data-one-add'));
      seriesCtx.selected=new Set([i]); addSelectedExternalToWish();
    }
  });

  // Feed actions
  document.addEventListener('click',function(e){
    var btn=e.target.closest && e.target.closest('[data-action]'); if(!btn) return;
    var action=btn.getAttribute('data-action'); var bookId=btn.getAttribute('data-id');
    function findBook(id){ return books.find(x=>String(x.id)===String(id)); }

    if(action==='toggle-synopsis'){
      var id=bookId; var wrap=document.querySelector('.syn[data-syn="'+id+'"]'); if(!wrap) return; var span=wrap.querySelector('.syn-text'); if(!span) return;
      var b=findBook(id); var full=(b && b.synopsis)||''; var expanded=span.getAttribute('data-expanded')==='true';
      if(expanded){ span.textContent=(full.length>280? full.slice(0,279)+'‚Ä¶' : full); span.setAttribute('data-expanded','false'); btn.textContent='Read more'; }
      else{ span.textContent=full; span.setAttribute('data-expanded','true'); btn.textContent='Show less'; }
      return;
    }
    if(action==='wish'){ var b=findBook(bookId); if(!b) return; setWish(b); saveAll(); applyFilters(false); updateStats(); showToast('Moved to Want to Read'); return; }
    if(action==='reading'){ var b2=findBook(bookId); if(!b2) return; startReading(b2); saveAll(); applyFilters(false); updateStats(); showToast('Marked as Currently Reading'); return; }
    if(action==='finish'){ var b3=findBook(bookId); if(!b3) return; openFinishModal(b3); return; }
    if(action==='edit'){ var b4=findBook(bookId); if(!b4) return; var t=prompt('Edit title:', b4.title); if(t==null) return; b4.title=t.trim()||b4.title; var a=prompt('Edit author:', b4.author); if(a==null) return; b4.author=a.trim()||b4.author; saveAll(); applyFilters(false); updateStats(); return; }
    if(action==='delete'){ if(!confirm('Delete this book?')) return; books = books.filter(x=>String(x.id)!==String(bookId)); saveAll(); applyFilters(false); updateStats(); showToast('Deleted'); return; }
    if(action==='find-next'){
      var cur=findBook(bookId); if(!cur || !cur.series || !cur.series.name){ showToast('No series info on this book', true); return; }
      (async ()=>{
        openSearchModal(cur.series.name, cur.author||'');
        await runExternalSearch(cur.series.name, cur.author||'');
        // preselect first volume with higher number
        const cn = Number(cur.series.number||0);
        const idx = seriesCtx.items.findIndex(it => it.seriesNumberGuess!=null && it.seriesNumberGuess>cn);
        if(idx>-1){ seriesCtx.selected = new Set([idx]); renderExternalResults(); }
      })();
      return;
    }
    if(action==='find-like'){
      var b5=findBook(bookId); if(!b5) return;
      const q = (b5.tags&&b5.tags.length)? b5.tags.slice(0,3).join(' ') : `${b5.title} ${b5.author}`;
      openSearchModal(q, '');
      runExternalSearch(q,'');
      return;
    }
  });

  // Finish modal
  function saveFinish(){
    try{
      if(!finishContext){ closeFinishModal(); return; }
      var book=books.find(b=>b.id===finishContext.bookId);
      if(!book){ closeFinishModal(); return; }
      finishReading(book, ratingDraft||book.rating||0);
      book.status='read';
      saveAll(); closeFinishModal(); applyFilters(false); updateStats(); showToast('Marked as read!');
    }catch(e){ console.warn(e); closeFinishModal(); showToast('Saved locally. If something looks off, refresh.',true); }
  }
  document.getElementById('finish-save').addEventListener('click', saveFinish);
  document.getElementById('finish-cancel').addEventListener('click', closeFinishModal);
  document.addEventListener('keydown',function(e){
    if(e.key==='Escape' && document.getElementById('finish-modal').classList.contains('show')) closeFinishModal();
    if(e.key==='Enter' && document.getElementById('finish-modal').classList.contains('show')) saveFinish();
  });
  document.addEventListener('click',function(e){
    var m=document.getElementById('finish-modal'); if(!m || !m.classList.contains('show')) return;
    if(!m.contains(e.target) && !e.target.closest('#finish-modal')) closeFinishModal();
  });

  // Goals
  function loadGoalsUI(){
    var g=sitePrefs.goals||{year:new Date().getFullYear(), total:0, byTag:{}};
    document.getElementById('goal-year').value=g.year||new Date().getFullYear();
    document.getElementById('goal-total').value=g.total||0;
    document.getElementById('goal-catholic').value=(g.byTag&&g.byTag.catholic)||0;
    document.getElementById('goal-fiction').value=(g.byTag&&g.byTag.fiction)||0;
    document.getElementById('goal-nonfiction').value=(g.byTag&&g.byTag.nonfiction)||0;
  }
  loadGoalsUI();
  document.getElementById('save-goals').addEventListener('click', function(){
    var g=sitePrefs.goals||{};
    g.year=parseInt(document.getElementById('goal-year').value,10)||new Date().getFullYear();
    g.total=parseInt(document.getElementById('goal-total').value,10)||0;
    g.byTag=g.byTag||{};
    g.byTag.catholic=parseInt(document.getElementById('goal-catholic').value,10)||0;
    g.byTag.fiction=parseInt(document.getElementById('goal-fiction').value,10)||0;
    g.byTag.nonfiction=parseInt(document.getElementById('goal-nonfiction').value,10)||0;
    sitePrefs.goals=g; saveAll(); showToast('Goals saved');
  });

  // Export/Import
  document.getElementById('export-csv-btn').addEventListener('click', exportCsvs);
  document.getElementById('export-json-btn').addEventListener('click', exportJson);
  document.getElementById('import-json').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(f) importJson(f); e.target.value=''; });

  // Cloud controls
  document.getElementById('cloud-save').addEventListener('click', function(){
    const key = (document.getElementById('cloud-api').value||'').trim();
    const bin = (document.getElementById('cloud-bin').value||'').trim();
    if(key){ localStorage.setItem('plotline_api_key', key); }
    if(bin){ localStorage.setItem('plotline_bin_id', bin); }
    showToast('Cloud settings saved');
  });
  document.getElementById('cloud-create').addEventListener('click', cloudCreate);
  document.getElementById('cloud-pull').addEventListener('click', cloudPull);
  document.getElementById('cloud-push').addEventListener('click', cloudPush);
});

function openSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(id==='feed') document.getElementById('feed-btn').classList.add('active');
  if(id==='prefs') document.getElementById('prefs-btn').classList.add('active');
}
</script>
</body>
</html>
